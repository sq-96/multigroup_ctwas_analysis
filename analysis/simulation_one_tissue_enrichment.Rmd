---
title: "simulation_one_tissue_enrichment"
output: html_document
date: '2024-4-28'
editor_options: 
  chunk_output_type: console
---

## One tissue simulation
```{r echo=FALSE}
library(ctwas)
library(tidyr)
library(dplyr)
library(ggplot2)
library(data.table)
library(ggbreak) 
library(ggpubr)
library(gridExtra)
source("/project/xinhe/shengqian/cTWAS_simulation/code/simulation_help_functions.R")
source("/project/xinhe/shengqian/cTWAS_simulation/code/summarize_basic_plots.R")
source("/project/xinhe/shengqian/cTWAS_simulation/code/summarize_ctwas_plots.R")

plot_prior_inclusion <- function(results_dir,runtag,simutags,thins,group_prior_var_structures,null_methods, file_name, true_value_gene,true_value_SNP){
  par(mfrow = c(1, 2))
  for(group_prior_var_structure in group_prior_var_structures){
    for(thin in thins){
      param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, "ctwas", file_name)
      y1 <- param_df_ctwas$`prior_liver|expression`
      y2 <- param_df_ctwas$prior_SNP
      param_df_susie <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, "susie", file_name)
      y3 <- param_df_susie$`prior_liver|expression`
      y4 <- param_df_susie$prior_SNP
      truth <- rbind(c(1,true_value_gene),c(2,true_value_SNP),c(3,true_value_gene),c(4,true_value_SNP))
      est <- rbind(cbind(1,y1),cbind(2,y2),cbind(3,y3),cbind(4,y4))
      plot_par_4(truth,est,xlabels = c("Gene (ctwas)", "SNP (ctwas)", "Gene (susie)","SNP (susie)"),ylim=c(0,max(est[,2],truth[,2])),ylab="Prior inclusion", main=group_prior_var_structure)
    }
  }
}

plot_prior_variance <- function(results_dir,runtag,thins,group_prior_var_structures,null_methods,file_name,true_value_gene,true_value_SNP){
  par(mfrow = c(1, 2))
  for(group_prior_var_structure in group_prior_var_structures){
    for(thin in thins){
      param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, "ctwas", file_name)
      y1 <- param_df_ctwas$`prior_var_liver|expression`
      y2 <- param_df_ctwas$prior_var_SNP
      param_df_susie <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, "susie", file_name)
      y3 <- param_df_susie$`prior_var_liver|expression`
      y4 <- param_df_susie$prior_var_SNP
      truth <- rbind(c(1,true_value_gene),c(2,true_value_SNP),c(3,true_value_gene),c(4,true_value_SNP))
      est <- rbind(cbind(1,y1),cbind(2,y2),cbind(3,y3),cbind(4,y4))
      plot_par_4(truth,est,xlabels = c("Gene (ctwas)", "SNP (ctwas)", "Gene (susie)","SNP (susie)"),ylim=c(0,max(est[,2],truth[,2])),ylab="Prior variance", main=group_prior_var_structure)
    }
  }
}

plot_enrichment <- function(results_dir, runtag, simutags, enrichment_true) {
  plot_df <- data.frame()
  
  for (i in 1:length(names(simutags))) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags[[names(simutags)[i]]], 1, "shared_all", "ctwas", ".Gtest.minp0.mingene0.parameters.RDS")
    df <- data.frame(
      group = rep(names(simutags)[i], each = 10),
      pos = rep(i, 10),
      enrichment = c(param_df_ctwas$`enrichment_Whole_Blood|expression`),
      se = c(param_df_ctwas$`enrichment_se_Whole_Blood|expression`)
    )
    
    df$pos <- jitter(df$pos, amount = 0.2)
    plot_df <- rbind(plot_df, df)
  }
  
  # Prepare hline data: start and end x for each group
  hline_df <- data.frame(
    group = names(enrichment_true),
    pos = 1:length(enrichment_true),
    yintercept = unlist(enrichment_true)
  )
  
  # Plot
  p <- ggplot(plot_df, aes(x = pos, y = enrichment, group = group, color = group)) +
    geom_point() +
    geom_errorbar(aes(ymin = enrichment - 1.96 * se, ymax = enrichment + 1.96 * se), width = 0.01) +
    geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept, color = group),
                 linetype = "dashed", inherit.aes = FALSE) +
    labs(x = "", y = "log(Enrichment)", title = "Enrichment Plot") +
    scale_x_continuous(breaks = 1:5, labels = names(simutags)) +
    ylim(c(-5,5)) +
    theme_minimal() +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )
  
  print(p)
}

plot_PVE <- function(results_dir, runtag, simutags, pve_true) {
  plot_df <- data.frame()
  
  for (i in 1:length(names(simutags))) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags[[names(simutags)[i]]], 1, "shared_all", "ctwas", ".Gtest.minp0.mingene0.parameters.RDS")
    df <- data.frame(
      group = rep(names(simutags)[i], each = 10),
      pos = rep(i, 10),
      pve = c(param_df_ctwas$`pve_Whole_Blood|expression`),
      se = c(0,10)
    )
    
    df$pos <- jitter(df$pos, amount = 0.2)
    plot_df <- rbind(plot_df, df)
  }
  
  # Prepare hline data: start and end x for each group
  hline_df <- data.frame(
    group = names(pve_true),
    pos = 1:length(pve_true),
    yintercept = unlist(pve_true)
  )
  
  # Plot
  p <- ggplot(plot_df, aes(x = pos, y = pve, group = group, color = group)) +
    geom_point() +
    geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept, color = group),
                 linetype = "dashed", inherit.aes = FALSE) +
    labs(x = "", y = "PVE", title = "PVE Plot") +
    scale_x_continuous(breaks = 1:5, labels = names(simutags)) +
    ylim(c(0,0.4)) +
    theme_minimal() +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )
  
  print(p)
}
```

## Simulation Parameters
```{r eval=FALSE}
sigma_gene =  c(0.0155,   0.0155,   0.0155,    0.0155,    0.0155)
pi_gene =     c(0.0025,   0.025,    0.05,      0.1,       0.2)
size_gene =   c(8170,     8170,     8170,      8170,      8170)

sigma_snp =   c(0.0155,   0.0155,   0.0155,    0.0155,    0.0155)
pi_snp =      c(0.0025,   0.0025,   0.0025,    0.0025,    0.0025)
size_snp =    c(500000,   500000,   500000,    500000,    500000)
```

## Enrichment Parameter
```{r,echo=FALSE,fig.width= 8, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_one_tissue_expression_enrichment/"
runtag = "one_tissue"
simutags <- list("enrichment 1"=paste(1, 1:10, sep = "-"),
                 "enrichment 10"=paste(2, 1:10, sep = "-"),
                 "enrichment 20"=paste(3, 1:10, sep = "-"),
                 "enrichment 40"=paste(4, 1:10, sep = "-"),
                 "enrichment 80"=paste(5, 1:10, sep = "-"))

enrichment_true <- list("1"=0,
                        "2"=log(10,base=exp(1)),
                        "3"=log(20,base=exp(1)),
                        "4"=log(40,base=exp(1)),
                        "5"=log(80,base=exp(1)))

plot_enrichment(results_dir,runtag,simutags,enrichment_true)
```

## PVE Parameter (true value calculated with formula in ctwas paper)
```{r echo=FALSE}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_one_tissue_expression_enrichment/"
runtag = "one_tissue"
simutags <- list("enrichment 1"=paste(1, 1:10, sep = "-"),
                 "enrichment 10"=paste(2, 1:10, sep = "-"),
                 "enrichment 20"=paste(3, 1:10, sep = "-"),
                 "enrichment 40"=paste(4, 1:10, sep = "-"),
                 "enrichment 80"=paste(5, 1:10, sep = "-"))

pi <- c(0.0025,   0.025,    0.05,      0.1,       0.2)
sigma_beta <- c(0.0155,   0.0155,   0.0155,    0.0155,    0.0155)
gene_size <- 8170
pve <- sigma_beta^2 * pi * gene_size

pve_true <- list("1"=pve[1],
                 "2"=pve[2],
                 "3"=pve[3],
                 "4"=pve[4],
                 "5"=pve[5])

plot_PVE(results_dir,runtag,simutags,pve_true)
```

## PVE Parameter (true value calculated when simulating phenotype data [var.gene <- var(X.g %*% e.beta)], 10 replicates, take average)
```{r echo=FALSE}
data_pve <- c()
for(i in names(simutags)){
  tmp_pve <- c()
  for(j in simutags[[i]]){
    pve <- get(load(paste0("/project/xinhe/shengqian/cTWAS_simulation/simulation_one_tissue_expression_enrichment/one_tissue_simu",j,"-pheno.Rd")))
    pve <- pve$param$pve.gene.truth
    tmp_pve <- c(tmp_pve,pve)
  }
  data_pve <- c(data_pve,mean(tmp_pve))
}

pve_data <- list("1"=data_pve[1],
                 "2"=data_pve[2],
                 "3"=data_pve[3],
                 "4"=data_pve[4],
                 "5"=data_pve[5])

plot_PVE(results_dir,runtag,simutags,pve_data)
```

