---
title: "simulation_five_uncorrelated_tissues_three_omics"
output: html_document
date: '2024-5-26'
editor_options: 
  chunk_output_type: console
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ctwas)
library(tidyr)
library(dplyr)
library(ggplot2)
library(data.table)
library(ggbreak) 
library(ggpubr)
library(gridExtra)
source("/project/xinhe/shengqian/cTWAS_simulation/code/simulation_help_functions.R")
source("/project/xinhe/shengqian/cTWAS_simulation/code/summarize_basic_plots.R")
source("/project/xinhe/shengqian/cTWAS_simulation/code/summarize_ctwas_plots.R")

plot_Prior <- function(results_dir, runtag, simutags, thins, group_prior_var_structure, null_method, file_name, prior_true) {
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
    for (thin in thins) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, null_method, file_name)
      
    df <- data.frame(null_method = rep(c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST"), each = 10),
                       pos = c(rep(1, 10), rep(2, 10), rep(3, 10), rep(4, 10), rep(5, 10), 
                               rep(6, 10), rep(7, 10), rep(8, 10), rep(9, 10), rep(10, 10),
                               rep(11, 10), rep(12, 10), rep(13, 10), rep(14, 10), rep(15, 10)),
                       prior = c(param_df_ctwas$`prior_Whole_Blood|expression`,
                                 param_df_ctwas$`prior_Liver|expression`,
                                 param_df_ctwas$`prior_Heart_Left_Ventricle|expression`,
                                 param_df_ctwas$`prior_Stomach|expression`,
                                 param_df_ctwas$`prior_Lung|expression`,
                                 param_df_ctwas$`prior_Whole_Blood|splicing`,
                                 param_df_ctwas$`prior_Liver|splicing`,
                                 param_df_ctwas$`prior_Heart_Left_Ventricle|splicing`,
                                 param_df_ctwas$`prior_Stomach|splicing`,
                                 param_df_ctwas$`prior_Lung|splicing`,
                                 param_df_ctwas$`prior_Whole_Blood|stability`,
                                 param_df_ctwas$`prior_Liver|stability`,
                                 param_df_ctwas$`prior_Heart_Left_Ventricle|stability`,
                                 param_df_ctwas$`prior_Stomach|stability`,
                                 param_df_ctwas$`prior_Lung|stability`)) 
      
    df$pos <- jitter(df$pos, amount = 0.2)
    
    # Prepare hline data: start and end x for each group
    hline_df <- data.frame(
      pos = 1:15,
      yintercept = prior_true
    )
      
    p <- ggplot(df, aes(x = pos, y = prior, group = null_method, color = null_method)) +
        geom_point() +
        geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept),
                 linetype = "dashed", inherit.aes = FALSE) +
        labs(x = "", y = "Prior", title = thin) +
        scale_x_continuous(breaks = 1:15, labels = c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST")) +
        ylim(c(0,0.015)) +
        theme_minimal()+
        theme(legend.position = "none")
      
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}

plot_enrichment <- function(results_dir, runtag, simutags, thins, group_prior_var_structure, null_method, file_name, enrichment_true) {
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
  for (thin in thins) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, null_method, file_name)
      
    df <- data.frame(null_method = rep(c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST"), each = 10),
                       pos = c(rep(1, 10), rep(2, 10), rep(3, 10), rep(4, 10), rep(5, 10), 
                               rep(6, 10), rep(7, 10), rep(8, 10), rep(9, 10), rep(10, 10),
                               rep(11, 10), rep(12, 10), rep(13, 10), rep(14, 10), rep(15, 10)),
                       enrichment = c(param_df_ctwas$`enrichment_Whole_Blood|expression`,
                                 param_df_ctwas$`enrichment_Liver|expression`,
                                 param_df_ctwas$`enrichment_Heart_Left_Ventricle|expression`,
                                 param_df_ctwas$`enrichment_Stomach|expression`,
                                 param_df_ctwas$`enrichment_Lung|expression`,
                                 param_df_ctwas$`enrichment_Whole_Blood|splicing`,
                                 param_df_ctwas$`enrichment_Liver|splicing`,
                                 param_df_ctwas$`enrichment_Heart_Left_Ventricle|splicing`,
                                 param_df_ctwas$`enrichment_Stomach|splicing`,
                                 param_df_ctwas$`enrichment_Lung|splicing`,
                                 param_df_ctwas$`enrichment_Whole_Blood|stability`,
                                 param_df_ctwas$`enrichment_Liver|stability`,
                                 param_df_ctwas$`enrichment_Heart_Left_Ventricle|stability`,
                                 param_df_ctwas$`enrichment_Stomach|stability`,
                                 param_df_ctwas$`enrichment_Lung|stability`),
                       se = c(param_df_ctwas$`enrichment_se_Whole_Blood|expression`,
                                 param_df_ctwas$`enrichment_se_Liver|expression`,
                                 param_df_ctwas$`enrichment_se_Heart_Left_Ventricle|expression`,
                                 param_df_ctwas$`enrichment_se_Stomach|expression`,
                                 param_df_ctwas$`enrichment_se_Lung|expression`,
                                 param_df_ctwas$`enrichment_se_Whole_Blood|splicing`,
                                 param_df_ctwas$`enrichment_se_Liver|splicing`,
                                 param_df_ctwas$`enrichment_se_Heart_Left_Ventricle|splicing`,
                                 param_df_ctwas$`enrichment_se_Stomach|splicing`,
                                 param_df_ctwas$`enrichment_se_Lung|splicing`,
                                 param_df_ctwas$`enrichment_se_Whole_Blood|stability`,
                                 param_df_ctwas$`enrichment_se_Liver|stability`,
                                 param_df_ctwas$`enrichment_se_Heart_Left_Ventricle|stability`,
                                 param_df_ctwas$`enrichment_se_Stomach|stability`,
                                 param_df_ctwas$`enrichment_se_Lung|stability`)) 
      
    df$pos <- jitter(df$pos, amount = 0.2)
    
    # Prepare hline data: start and end x for each group
    hline_df <- data.frame(
      pos = 1:15,
      yintercept = enrichment_true
    )
      
    p <- ggplot(df, aes(x = pos, y = enrichment, group = null_method, color = null_method)) +
        geom_point() +
        geom_errorbar(aes(ymin = enrichment - 1.96 * se, ymax = enrichment + 1.96 * se), width = 0.01) +
        geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept),
                 linetype = "dashed", inherit.aes = FALSE) +
        labs(x = "", y = "log(Enrichment)", title = thin) +
        scale_x_continuous(breaks = 1:15, labels = c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST")) +
        ylim(c(-15,5)) +
        theme_minimal()+
        theme(legend.position = "none")
      
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}

plot_PVE <- function(results_dir, runtag, simutags, thins, group_prior_var_structure, null_method, file_name, PVE_true) {
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
  for (thin in thins) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, null_method, file_name)
      
    df <- data.frame(null_method = rep(c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST"), each = 10),
                       pos = c(rep(1, 10), rep(2, 10), rep(3, 10), rep(4, 10), rep(5, 10), 
                               rep(6, 10), rep(7, 10), rep(8, 10), rep(9, 10), rep(10, 10),
                               rep(11, 10), rep(12, 10), rep(13, 10), rep(14, 10), rep(15, 10)),
                       pve = c(param_df_ctwas$`pve_Whole_Blood|expression`,
                                 param_df_ctwas$`pve_Liver|expression`,
                                 param_df_ctwas$`pve_Heart_Left_Ventricle|expression`,
                                 param_df_ctwas$`pve_Stomach|expression`,
                                 param_df_ctwas$`pve_Lung|expression`,
                                 param_df_ctwas$`pve_Whole_Blood|splicing`,
                                 param_df_ctwas$`pve_Liver|splicing`,
                                 param_df_ctwas$`pve_Heart_Left_Ventricle|splicing`,
                                 param_df_ctwas$`pve_Stomach|splicing`,
                                 param_df_ctwas$`pve_Lung|splicing`,
                                 param_df_ctwas$`pve_Whole_Blood|stability`,
                                 param_df_ctwas$`pve_Liver|stability`,
                                 param_df_ctwas$`pve_Heart_Left_Ventricle|stability`,
                                 param_df_ctwas$`pve_Stomach|stability`,
                                 param_df_ctwas$`pve_Lung|stability`)) 
      
    df$pos <- jitter(df$pos, amount = 0.2)
    
    # Prepare hline data: start and end x for each group
    hline_df <- data.frame(
      pos = 1:15,
      yintercept = PVE_true
    )
      
    p <- ggplot(df, aes(x = pos, y = pve, group = null_method, color = null_method)) +
        geom_point() +
        geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept),
                 linetype = "dashed", inherit.aes = FALSE) +
        labs(x = "", y = "PVE", title = thin) +
        scale_x_continuous(breaks = 1:15, labels = c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST")) +
        ylim(c(0,0.1)) +
        theme_minimal()+
        theme(legend.position = "none")
      
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}

plot_PHE <- function(results_dir, runtag, simutags, thins, group_prior_var_structure, null_method, file_name, PHE_true) {
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
  for (thin in thins) {
    param_df_ctwas <- load_parameters(results_dir, runtag, simutags, thin, group_prior_var_structure, null_method, file_name)
      
    df <- data.frame(null_method = rep(c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST"), each = 10),
                       pos = c(rep(1, 10), rep(2, 10), rep(3, 10), rep(4, 10), rep(5, 10), 
                               rep(6, 10), rep(7, 10), rep(8, 10), rep(9, 10), rep(10, 10),
                               rep(11, 10), rep(12, 10), rep(13, 10), rep(14, 10), rep(15, 10)),
                       phe = c(param_df_ctwas$`prop_heritability_Whole_Blood|expression`,
                                 param_df_ctwas$`prop_heritability_Liver|expression`,
                                 param_df_ctwas$`prop_heritability_Heart_Left_Ventricle|expression`,
                                 param_df_ctwas$`prop_heritability_Stomach|expression`,
                                 param_df_ctwas$`prop_heritability_Lung|expression`,
                                 param_df_ctwas$`prop_heritability_Whole_Blood|splicing`,
                                 param_df_ctwas$`prop_heritability_Liver|splicing`,
                                 param_df_ctwas$`prop_heritability_Heart_Left_Ventricle|splicing`,
                                 param_df_ctwas$`prop_heritability_Stomach|splicing`,
                                 param_df_ctwas$`prop_heritability_Lung|splicing`,
                                 param_df_ctwas$`prop_heritability_Whole_Blood|stability`,
                                 param_df_ctwas$`prop_heritability_Liver|stability`,
                                 param_df_ctwas$`prop_heritability_Heart_Left_Ventricle|stability`,
                                 param_df_ctwas$`prop_heritability_Stomach|stability`,
                                 param_df_ctwas$`prop_heritability_Lung|stability`)) 
      
    df$pos <- jitter(df$pos, amount = 0.2)
    
    # Prepare hline data: start and end x for each group
    hline_df <- data.frame(
      pos = 1:15,
      yintercept = PHE_true
    )
      
    p <- ggplot(df, aes(x = pos, y = phe, group = null_method, color = null_method)) +
        geom_point() +
        geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept),
                 linetype = "dashed", inherit.aes = FALSE) +
        labs(x = "", y = "PHE", title = thin) +
        scale_x_continuous(breaks = 1:15, labels = c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST")) +
        ylim(c(0,0.15)) +
        theme_minimal()+
        theme(legend.position = "none")
      
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}

plot_single_PHE <- function(results_dir, runtag_list, thins, PHE_true) {
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
  for (thin in thins) {
    PHE_list <- list()
    for(i in runtag_list){
      for(j in 1:10){
        param_df_ctwas <- readRDS(paste0(results_dir,i,"_simu1-",j,".thin1.shared_all.ctwas.minp08.mingene0.parameters.RDS"))
        PHE_list[[i]] <- c(PHE_list[[i]],param_df_ctwas$prop_heritability[1])
      }
    }
      
    df <- data.frame(null_method = rep(c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST"), each = 10),
                       pos = c(rep(1, 10), rep(2, 10), rep(3, 10), rep(4, 10), rep(5, 10), 
                               rep(6, 10), rep(7, 10), rep(8, 10), rep(9, 10), rep(10, 10),
                               rep(11, 10), rep(12, 10), rep(13, 10), rep(14, 10), rep(15, 10)),
                       phe = unlist(PHE_list)) 
      
    df$pos <- jitter(df$pos, amount = 0.2)
    
    # Prepare hline data: start and end x for each group
    hline_df <- data.frame(
      pos = 1:15,
      yintercept = PHE_true
    )
      
    p <- ggplot(df, aes(x = pos, y = phe, group = null_method, color = null_method)) +
        geom_point() +
        geom_segment(data = hline_df,
                 aes(x = pos - 0.3, xend = pos + 0.3, 
                     y = yintercept, yend = yintercept),
                 linetype = "dashed", inherit.aes = FALSE) +
        labs(x = "", y = "PHE", title = thin) +
        scale_x_continuous(breaks = 1:15, labels = c("blood E",  "Liver E",  "Heart E",  "Stomach E",  "Lung E",
                                         "blood S",  "Liver S",  "Heart S",  "Stomach S",  "Lung S",
                                         "blood ST", "Liver ST", "Heart ST", "Stomach ST", "Lung ST")) +
        ylim(c(0,0.15)) +
        theme_minimal()+
        theme(legend.position = "none")
      
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}

plot_power <- function(results_dir,runtag,thins){
  plots <- list()  # Store plots in a list
  plot_idx <- 1
  
  for (thin in thins) {
    pipfs_all_ctwas <- paste0(results_dir, runtag, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    phenofs <- paste0(results_dir, runtag, "_simu", paste(1, 1:10, sep = "-"), "-pheno.Rd")
    cau <- lapply(phenofs, function(x) {load(x);get_causal_id(phenores)})
    df_all_ctwas <- NULL
    for (i in 1:length(pipfs_all_ctwas)) {
      res <- readRDS(pipfs_all_ctwas[i])
      res <- res$finemap_res
      res <- data.frame(res[res$type!="SNP", ])
      res$runtag <- i
      res$ifcausal <- ifelse(res$id %in% cau[[i]], 1, 0)
      df_all_ctwas <- rbind(df_all_ctwas, res)
    }
  
    breaks_ranges = rbind(c(0.5, 1), c(0.8,1))
    power_df <- data.frame()
    for(i in 1:nrow(breaks_ranges)){
      breaks = breaks_ranges[i,]
      n_all_ctwas = length(which(df_all_ctwas$susie_pip >= breaks[1] & df_all_ctwas$susie_pip < breaks[2]))
      n_all_ctwas_causal = length(which(df_all_ctwas$susie_pip >= breaks[1] & df_all_ctwas$susie_pip < breaks[2] & df_all_ctwas$ifcausal > 0))
      tmp_df <- data.frame(
        "pip_bin" = paste0("PIP: ", breaks[1], "-", breaks[2]),
        "method" = rep(c("ctwas shared all"), 2),
        "group" = rep(c("total", "causal"), each = 1),
        "n_var" = c(n_all_ctwas,n_all_ctwas_causal))
      power_df <- rbind(power_df, tmp_df)
    }
    power_df$method <- factor(power_df$method, levels = c("ctwas shared all"))
    p <- ggplot(power_df) +
    geom_bar(aes(x = method, y = n_var, fill = group),position = "identity", stat = "identity", alpha=0.5, width=0.5) +
    facet_grid(~ pip_bin) +
    labs(x = paste0("Thin ",thin), y = "number of molecular traits") +
    scale_fill_manual(values = c("causal" = "red", "total" = "grey")) + 
    theme_cowplot()+
    theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())
    plots[[plot_idx]] <- p  # Store plot in the list
    plot_idx <- plot_idx + 1
  }
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))  # Using gridExtra
  } else {
    print(plots[[1]])
  }
}


plot_molecular_power_compare_group <- function(results_dir, runtag1, runtag2, thins) {
  plots <- list()
  plot_idx <- 1
  
  for (thin in thins) {
    # Method 1 files (original)
    pipfs_method1 <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    # Method 2 files (new comparison method)
    pipfs_method2 <- paste0(results_dir, runtag2, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    phenofs <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"), "-pheno.Rd")
    cau <- lapply(phenofs, function(x) {load(x);get_causal_id(phenores)})
    
    # Process both methods
    process_method <- function(pip_files, method_name) {
      sim_results <- list()
      for (i in 1:length(pip_files)) {
        res <- readRDS(pip_files[i])
        res <- res$finemap_res
        res <- data.frame(res[res$type!="SNP", ])
        res$runtag <- i
        res$ifcausal <- ifelse(res$id %in% cau[[i]], 1, 0)
        res$method <- method_name
        sim_results[[i]] <- res
      }
      return(sim_results)
    }
    
    method1_results <- process_method(pipfs_method1, "Joint")
    method2_results <- process_method(pipfs_method2, "Single group")
    
    breaks_ranges = rbind(c(0.5, 1), c(0.8,1))
    power_df <- data.frame()
    
    calculate_stats <- function(sim_results, method_name) {
      df <- data.frame()
      for(i in 1:nrow(breaks_ranges)){
        breaks = breaks_ranges[i,]
        
        n_total <- sapply(sim_results, function(df) {
          length(which(df$susie_pip >= breaks[1] & df$susie_pip < breaks[2]))
        })
        
        n_causal <- sapply(sim_results, function(df) {
          length(which(df$susie_pip >= breaks[1] & df$susie_pip < breaks[2] & df$ifcausal > 0))
        })
        
        mean_total <- mean(n_total)
        se_total <- sd(n_total)/sqrt(length(n_total))
        
        mean_causal <- mean(n_causal)
        se_causal <- sd(n_causal)/sqrt(length(n_causal))
        
        tmp_df <- data.frame(
          "pip_bin" = paste0("PIP: ", breaks[1], "-", breaks[2]),
          "method" = method_name,
          "group" = c("total", "causal"),
          "mean" = c(mean_total, mean_causal),
          "se" = c(se_total, se_causal))
        
        df <- rbind(df, tmp_df)
      }
      return(df)
    }
    
    power_df <- rbind(
      calculate_stats(method1_results, "Joint"),
      calculate_stats(method2_results, "Single group")
    )
    
    power_df$method <- factor(power_df$method, levels = c("Joint", "Single group"))
    power_df$group <- factor(power_df$group, levels = c("total", "causal"))
    
    # Create comparison plot with overlayed bars
    p <- ggplot(power_df, aes(x = method, y = mean, fill = group)) +
      # Total genes (background, semi-transparent)
      geom_col(data = subset(power_df, group == "total"), 
               position = position_identity(), width = 0.7, alpha = 0.4) +
      # Causal genes (foreground, more opaque)
      geom_col(data = subset(power_df, group == "causal"), 
               position = position_identity(), width = 0.7, alpha = 0.7) +
      # Error bars for total genes
      geom_errorbar(data = subset(power_df, group == "total"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "gray40") +
      # Error bars for causal genes
      geom_errorbar(data = subset(power_df, group == "causal"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "firebrick") +
      facet_grid(~ pip_bin) +
      labs(x = paste0("Thin ", thin), 
           y = "Average number of molecular traits",
           fill = "Group") +
      scale_fill_manual(values = c("total" = "gray70", "causal" = "indianred"),
                       labels = c("total" = "All genes", "causal" = "Causal genes")) +
      theme_cowplot() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "top",
            legend.title = element_text(size = 10),
            legend.text = element_text(size = 9),
            strip.text = element_text(size = 10),
            axis.title.y = element_text(size = 10))
    
    plots[[plot_idx]] <- p
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))
  } else {
    print(plots[[1]])
  }
}

plot_gene_power_compare_group <- function(results_dir, runtag1, runtag2, thins, mapping_table) {
  plots <- list()
  plot_idx <- 1
  
  for (thin in thins) {
    # Method 1 files (original)
    pipfs_method1 <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    # Method 2 files (new comparison method)
    pipfs_method2 <- paste0(results_dir, runtag2, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    phenofs <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"), "-pheno.Rd")
    cau <- lapply(phenofs, function(x) {load(x);get_causal_id(phenores)})
    
    # Process both methods
    process_method <- function(pip_files, method_name) {
      sim_results <- list()
      for (i in 1:length(pip_files)) {
        res <- readRDS(pip_files[i])
        res <- anno_susie_alpha_res(res$susie_alpha_res,
                                mapping_table = mapping_table,
                                map_by = "molecular_id",
                                drop_unmapped = TRUE)
        
        res <- combine_gene_pips(res,
                             group_by = "gene_name",
                             by = "type",
                             method = "combine_cs",
                             filter_cs = FALSE,
                             include_cs_id = FALSE)
        res$runtag <- i
        true_genes <- unique(mapping_table[mapping_table$molecular_id %in% sapply(cau[[i]],function(x){unlist(strsplit(x, "[|]"))[1]}),"gene_name"])
        res$ifcausal <- ifelse(res$gene_name %in% true_genes, 1, 0)  
        res$method <- method_name
        sim_results[[i]] <- res
      }
      return(sim_results)
    }
    
    method1_results <- process_method(pipfs_method1, "Joint")
    method2_results <- process_method(pipfs_method2, "Single group")
    
    breaks_ranges = rbind(c(0.5, 1), c(0.8,1))
    power_df <- data.frame()
    
    calculate_stats <- function(sim_results, method_name) {
      df <- data.frame()
      for(i in 1:nrow(breaks_ranges)){
        breaks = breaks_ranges[i,]
        
        n_total <- sapply(sim_results, function(df) {
          length(which(df$combined_pip >= breaks[1] & df$combined_pip < breaks[2]))
        })
        
        n_causal <- sapply(sim_results, function(df) {
          length(which(df$combined_pip >= breaks[1] & df$combined_pip < breaks[2] & df$ifcausal > 0))
        })
        
        mean_total <- mean(n_total)
        se_total <- sd(n_total)/sqrt(length(n_total))
        
        mean_causal <- mean(n_causal)
        se_causal <- sd(n_causal)/sqrt(length(n_causal))
        
        tmp_df <- data.frame(
          "pip_bin" = paste0("PIP: ", breaks[1], "-", breaks[2]),
          "method" = method_name,
          "group" = c("total", "causal"),
          "mean" = c(mean_total, mean_causal),
          "se" = c(se_total, se_causal))
        
        df <- rbind(df, tmp_df)
      }
      return(df)
    }
    
    power_df <- rbind(
      calculate_stats(method1_results, "Joint"),
      calculate_stats(method2_results, "Single group")
    )
    
    power_df$method <- factor(power_df$method, levels = c("Joint", "Single group"))
    power_df$group <- factor(power_df$group, levels = c("total", "causal"))
    
    # Create comparison plot with overlayed bars
    p <- ggplot(power_df, aes(x = method, y = mean, fill = group)) +
      # Total genes (background, semi-transparent)
      geom_col(data = subset(power_df, group == "total"), 
               position = position_identity(), width = 0.7, alpha = 0.4) +
      # Causal genes (foreground, more opaque)
      geom_col(data = subset(power_df, group == "causal"), 
               position = position_identity(), width = 0.7, alpha = 0.7) +
      # Error bars for total genes
      geom_errorbar(data = subset(power_df, group == "total"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "gray40") +
      # Error bars for causal genes
      geom_errorbar(data = subset(power_df, group == "causal"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "firebrick") +
      facet_grid(~ pip_bin) +
      labs(x = paste0("Thin ", thin), 
           y = "Average number of genes",
           fill = "Group") +
      scale_fill_manual(values = c("total" = "gray70", "causal" = "indianred"),
                       labels = c("total" = "All genes", "causal" = "Causal genes")) +
      theme_cowplot() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "top",
            legend.title = element_text(size = 10),
            legend.text = element_text(size = 9),
            strip.text = element_text(size = 10),
            axis.title.y = element_text(size = 10))
    
    plots[[plot_idx]] <- p
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))
  } else {
    print(plots[[1]])
  }
}

plot_molecular_power_compare_method <- function(results_dir, runtag1, runtag_list1, runtag_list2, thins) {
  plots <- list()
  plot_idx <- 1
  
  for (thin in thins) {
    # Method 1 files (original) - 1 file per simulation
    pipfs_method1 <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    # Method 2 files (new comparison method) - 15 files per simulation
    pipfs_method2_list <- lapply(1:10, function(sim) {
      paste0(results_dir, runtag_list1, "_simu", paste(1, sim, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    })
    
    pipfs_method3_list <- lapply(1:10, function(sim) {
      paste0(results_dir, runtag_list2, "_simu", paste(1, sim, sep = "-"),".coloc_res.RDS")
    })
    
    phenofs <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"), "-pheno.Rd")
    cau <- lapply(phenofs, function(x) {load(x);get_causal_id(phenores)})
    
    # Process Method 1 (original method)
    process_method1 <- function(pip_files) {
      sim_results <- list()
      for (i in 1:length(pip_files)) {
        res <- readRDS(pip_files[i])
        res <- res$finemap_res
        res <- data.frame(res[res$type!="SNP", ])
        res$runtag <- i
        res$ifcausal <- ifelse(res$id %in% cau[[i]], 1, 0)
        res$method <- "Multi-cTWAS"
        sim_results[[i]] <- res
      }
      return(sim_results)
    }
    
    # Process Method 2 (new method with multiple files per simulation)
    process_method2 <- function(pip_files_list) {
      sim_results <- list()
      for (i in 1:length(pip_files_list)) {
        # Read all 15 files for this simulation
        res_list <- lapply(pip_files_list[[i]], function(f) {
          res <- readRDS(f)
          res <- res$finemap_res
          res <- data.frame(res[res$type!="SNP", ])
          res <- res[,c("id","susie_pip")]
          return(res)
        })
        res_list <- do.call(rbind, res_list)
        res_list$runtag <- i
        res_list$ifcausal <- ifelse(res_list$id %in% cau[[i]], 1, 0)
        res_list$method <- "Single-cTWAS"
        sim_results[[i]] <- res_list
      }
      return(sim_results)
    }
    
    process_method3 <- function(pip_files_list,runtag_list) {
      sim_results <- list()
      for (i in 1:length(pip_files_list)) {
        print(i)
        # Read all 15 files for this simulation
        res_list <- list()
        for(j in 1:length(pip_files_list[[i]])){
          print(j)
          res <- readRDS(pip_files_list[[i]][j])
          res$id <- paste0(res$id,"|",runtag_list[j])
          res_list[[j]] <- res
        }
        res_list <- do.call(rbind, res_list)
        colnames(res_list) <- c("id","gene_name","region_id","susie_pip","causalSNP")
        res_list$runtag <- i
        res_list$ifcausal <- ifelse(res_list$id %in% cau[[i]], 1, 0)
        res_list$method <- "Coloc"
        sim_results[[i]] <- res_list
      }
      return(sim_results)
    }
    
    method1_results <- process_method1(pipfs_method1)
    method2_results <- process_method2(pipfs_method2_list)
    method3_results <- process_method3(pipfs_method3_list,runtag_list2)
    
    breaks_ranges = rbind(c(0.5, 1), c(0.8,1))
    power_df <- data.frame()
    
    calculate_stats <- function(sim_results, method_name) {
      df <- data.frame()
      for(i in 1:nrow(breaks_ranges)){
        breaks = breaks_ranges[i,]
        
        n_total <- sapply(sim_results, function(df) {
          length(which(df$susie_pip >= breaks[1] & df$susie_pip < breaks[2]))
        })
        
        n_causal <- sapply(sim_results, function(df) {
          length(which(df$susie_pip >= breaks[1] & df$susie_pip < breaks[2] & df$ifcausal > 0))
        })
        
        mean_total <- mean(n_total)
        se_total <- sd(n_total)/sqrt(length(n_total))
        
        mean_causal <- mean(n_causal)
        se_causal <- sd(n_causal)/sqrt(length(n_causal))
        
        tmp_df <- data.frame(
          "pip_bin" = paste0("PIP: ", breaks[1], "-", breaks[2]),
          "method" = method_name,
          "group" = c("total", "causal"),
          "mean" = c(mean_total, mean_causal),
          "se" = c(se_total, se_causal))
        
        df <- rbind(df, tmp_df)
      }
      return(df)
    }
    
    power_df <- rbind(
      calculate_stats(method1_results, "Multi-cTWAS"),
      calculate_stats(method2_results, "Single-cTWAS"),
      calculate_stats(method3_results, "Coloc")
    )
    
    power_df$method <- factor(power_df$method, levels = c("Multi-cTWAS", "Single-cTWAS", "Coloc"))
    power_df$group <- factor(power_df$group, levels = c("total", "causal"))
    
    # Create comparison plot with overlayed bars
    p <- ggplot(power_df, aes(x = method, y = mean, fill = group)) +
      # Total genes (background, semi-transparent)
      geom_col(data = subset(power_df, group == "total"), 
               position = position_identity(), width = 0.7, alpha = 0.4) +
      # Causal genes (foreground, more opaque)
      geom_col(data = subset(power_df, group == "causal"), 
               position = position_identity(), width = 0.7, alpha = 0.7) +
      # Error bars for total genes
      geom_errorbar(data = subset(power_df, group == "total"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "gray40") +
      # Error bars for causal genes
      geom_errorbar(data = subset(power_df, group == "causal"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "firebrick") +
      facet_grid(~ pip_bin) +
      labs(x = paste0("Thin ", thin), 
           y = "Average number of molecular traits",
           fill = "Group") +
      scale_fill_manual(values = c("total" = "gray70", "causal" = "indianred"),
                       labels = c("total" = "All genes", "causal" = "Causal genes")) +
      theme_cowplot() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "top",
            legend.title = element_text(size = 10),
            legend.text = element_text(size = 9),
            strip.text = element_text(size = 10),
            axis.title.y = element_text(size = 10))
    
    plots[[plot_idx]] <- p
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))
  } else {
    print(plots[[1]])
  }
}

plot_gene_power_compare_method <- function(results_dir, runtag1, runtag_list1, runtag_list2, thins, mapping_table) {
  plots <- list()
  plot_idx <- 1
  
  for (thin in thins) {
    # Method 1 files (original) - 1 file per simulation
    pipfs_method1 <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    
    # Method 2 files (new comparison method) - 15 files per simulation
    pipfs_method2_list <- lapply(1:10, function(sim) {
      paste0(results_dir, runtag_list1, "_simu", paste(1, sim, sep = "-"),".thin",thin,".shared_all.ctwas.minp08.mingene0.estimated_parameter.finemap_regions_res.RDS")
    })
    
    pipfs_method3_list <- lapply(1:10, function(sim) {
      paste0(results_dir, runtag_list2, "_simu", paste(1, sim, sep = "-"),".coloc_res.RDS")
    })
    
    phenofs <- paste0(results_dir, runtag1, "_simu", paste(1, 1:10, sep = "-"), "-pheno.Rd")
    cau <- lapply(phenofs, function(x) {load(x);get_causal_id(phenores)})
    
    # Process Method 1 (original method)
    process_method1 <- function(pip_files) {
      sim_results <- list()
      for (i in 1:length(pip_files)) {
        res <- readRDS(pip_files[i])
        res <- anno_susie_alpha_res(res$susie_alpha_res,
                                mapping_table = mapping_table,
                                map_by = "molecular_id",
                                drop_unmapped = TRUE)
        
        res <- combine_gene_pips(res,
                             group_by = "gene_name",
                             by = "type",
                             method = "combine_cs",
                             filter_cs = FALSE,
                             include_cs_id = FALSE)
        res$runtag <- i
        true_genes <- unique(mapping_table[mapping_table$molecular_id %in% sapply(cau[[i]],function(x){unlist(strsplit(x, "[|]"))[1]}),"gene_name"])
        res$ifcausal <- ifelse(res$gene_name %in% true_genes, 1, 0)  
        res$method <- "Multi-cTWAS"
        sim_results[[i]] <- res
      }
      return(sim_results)
    }
    
    # Process Method 2 (new method with multiple files per simulation)
    process_method2 <- function(pip_files_list) {
      sim_results <- list()
      for (i in 1:length(pip_files_list)) {
        # Read all 15 files for this simulation
        res_list <- lapply(pip_files_list[[i]], function(f) {
          res <- readRDS(f)
          res <- anno_susie_alpha_res(res$susie_alpha_res,
                                  mapping_table = mapping_table,
                                  map_by = "molecular_id",
                                  drop_unmapped = TRUE)
          
          res <- combine_gene_pips(res,
                               group_by = "gene_name",
                               by = "type",
                               method = "combine_cs",
                               filter_cs = FALSE,
                               include_cs_id = FALSE)
          
          res <- res[,c("gene_name","combined_pip")]
          return(res)
        })
        
        combined_df <- do.call(rbind, res_list)
        # For each gene, keep only the row with the highest PIP
        combined_res <- combined_df %>% group_by(gene_name) %>% arrange(desc(combined_pip)) %>% slice(1) %>% ungroup()
        
        # Add other required columns
        combined_res$runtag <- i
        true_genes <- unique(mapping_table[mapping_table$molecular_id %in% sapply(cau[[i]],function(x){unlist(strsplit(x, "[|]"))[1]}),"gene_name"])
        combined_res$ifcausal <- ifelse(combined_res$gene_name %in% true_genes, 1, 0)
        combined_res$method <- "Single-cTWAS"
        
        sim_results[[i]] <- combined_res
      }
      return(sim_results)
    }
    
    process_method3 <- function(pip_files_list) {
      sim_results <- list()
      for (i in 1:length(pip_files_list)) {
        print(i)
        # Read all 15 files for this simulation
        res_list <- lapply(pip_files_list[[i]], function(f) {
          res <- readRDS(f)
          return(res)
        })
        
        combined_df <- do.call(rbind, res_list)
        # For each gene, keep only the row with the highest PIP
        combined_res <- combined_df %>% group_by(gene_name) %>% arrange(desc(PP4)) %>% slice(1) %>% ungroup()
        colnames(combined_res) <- c("id","gene_name","region_id","combined_pip","causalSNP")
        # Add other required columns
        combined_res$runtag <- i
        true_genes <- unique(mapping_table[mapping_table$molecular_id %in% sapply(cau[[i]],function(x){unlist(strsplit(x, "[|]"))[1]}),"gene_name"])
        combined_res$ifcausal <- ifelse(combined_res$gene_name %in% true_genes, 1, 0)
        combined_res$method <- "Coloc"
        
        sim_results[[i]] <- combined_res
      }
      return(sim_results)
    }
    
    method1_results <- process_method1(pipfs_method1)
    method2_results <- process_method2(pipfs_method2_list)
    method3_results <- process_method3(pipfs_method3_list)
    
    breaks_ranges = rbind(c(0.5, 1), c(0.8,1))
    power_df <- data.frame()
    
    calculate_stats <- function(sim_results, method_name) {
      df <- data.frame()
      for(i in 1:nrow(breaks_ranges)){
        breaks = breaks_ranges[i,]
        
        n_total <- sapply(sim_results, function(df) {
          length(which(df$combined_pip >= breaks[1] & df$combined_pip < breaks[2]))
        })
        
        n_causal <- sapply(sim_results, function(df) {
          length(which(df$combined_pip >= breaks[1] & df$combined_pip < breaks[2] & df$ifcausal > 0))
        })
        
        mean_total <- mean(n_total)
        se_total <- sd(n_total)/sqrt(length(n_total))
        
        mean_causal <- mean(n_causal)
        se_causal <- sd(n_causal)/sqrt(length(n_causal))
        
        tmp_df <- data.frame(
          "pip_bin" = paste0("PIP: ", breaks[1], "-", breaks[2]),
          "method" = method_name,
          "group" = c("total", "causal"),
          "mean" = c(mean_total, mean_causal),
          "se" = c(se_total, se_causal))
        
        df <- rbind(df, tmp_df)
      }
      return(df)
    }
    
    power_df <- rbind(
      calculate_stats(method1_results, "Multi-cTWAS"),
      calculate_stats(method2_results, "Single-cTWAS"),
      calculate_stats(method3_results, "Coloc")
    )
    
    power_df$method <- factor(power_df$method, levels = c("Multi-cTWAS", "Single-cTWAS", "Coloc"))
    power_df$group <- factor(power_df$group, levels = c("total", "causal"))
    
    # Create comparison plot with overlayed bars
    p <- ggplot(power_df, aes(x = method, y = mean, fill = group)) +
      # Total genes (background, semi-transparent)
      geom_col(data = subset(power_df, group == "total"), 
               position = position_identity(), width = 0.7, alpha = 0.4) +
      # Causal genes (foreground, more opaque)
      geom_col(data = subset(power_df, group == "causal"), 
               position = position_identity(), width = 0.7, alpha = 0.7) +
      # Error bars for total genes
      geom_errorbar(data = subset(power_df, group == "total"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "gray40") +
      # Error bars for causal genes
      geom_errorbar(data = subset(power_df, group == "causal"),
                   aes(ymin = mean - se, ymax = mean + se),
                   position = position_identity(),
                   width = 0.3, linewidth = 0.8, color = "firebrick") +
      facet_grid(~ pip_bin) +
      labs(x = paste0("Thin ", thin), 
           y = "Average number of genes",
           fill = "Group") +
      scale_fill_manual(values = c("total" = "gray70", "causal" = "indianred"),
                       labels = c("total" = "All genes", "causal" = "Causal genes")) +
      theme_cowplot() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "top",
            legend.title = element_text(size = 10),
            legend.text = element_text(size = 9),
            strip.text = element_text(size = 10),
            axis.title.y = element_text(size = 10))
    
    plots[[plot_idx]] <- p
    plot_idx <- plot_idx + 1
  }
  
  if (length(plots) > 1) {
    grid.arrange(grobs = plots, ncol = length(plots))
  } else {
    print(plots[[1]])
  }
}
```

```{r echo=FALSE}
plot_molecular_PIPs <- function(results_dir, runtag,  simutags, thin, group_prior_var_structure, null_method, file_name, ...){
  phenofs <- paste0(results_dir, runtag, "_simu", simutags, "-pheno.Rd")
  susieIfs <- paste0(results_dir, runtag, "_simu",simutags, ".thin", thin, ".", group_prior_var_structure, ".", null_method,file_name)
  f1 <- caliPIP_plot(phenofs, susieIfs, ...) 
  return(f1)
}

plot_gene_PIPs <- function(results_dir, runtag,  simutags, thin, group_prior_var_structure, null_method, mapping_table, file_name, ...){
  phenofs <- paste0(results_dir, runtag, "_simu", simutags, "-pheno.Rd")
  susieIfs <- paste0(results_dir, runtag, "_simu",simutags, ".thin", thin, ".", group_prior_var_structure,".", null_method, file_name)
  f1 <- caliPIP_plot_multi_omics(phenofs, susieIfs, mapping_table, ...) 
  return(f1)
}
```

## Simulation Parameters
```{r eval=FALSE}
pve_gene <- c(0.02, 0.02, 0, 0, 0, 0.01, 0.01, 0, 0, 0, 0.003, 0.003, 0, 0, 0)
group_size <- c(8170,7395,8274,8561,9774, 13273, 14245, 15620, 19358, 24842, 3479, 1930, 2834, 3271, 4751)
pve_snp <- 0.3
sigma_theta <- 0.02
sigma_beta <- 0.02
gene_prior <- c(0.009652920, 0.010664551, 0, 0, 0, 0.002970856, 0.002768142, 0, 0, 0, 0.003400303, 0.006129354, 0, 0, 0)
snp_prior <- 0.0002365931
```


```{r echo=FALSE}
pve_gene <- c(0.02, 0.02, 0, 0, 0,
              0.01, 0.01, 0, 0, 0,
              0.003, 0.003, 0, 0, 0)

group_size <- c(8170,7395,8274,8561,9774,
                13273, 14245, 15620, 19358, 24842,
                3479, 1930, 2834, 3271, 4751)
pve_snp <- 0.3
sigma_theta <- 0.02
sigma_beta <- 0.02
gene_prior <- pve_gene/sigma_beta^2/(1-sum(pve_gene)-pve_snp)/group_size
snp_prior <- pve_snp/sigma_beta^2/(1-sum(pve_gene)-pve_snp)/5000000

thins <- c(1)

prior_true <- gene_prior
  
enrichment_true <- log(gene_prior/snp_prior,base = exp(1))

pve_true <- pve_gene

phe_true <- pve_gene/(sum(pve_gene)+pve_snp)
```

## shared_all, ctwas null weight

### Prior
```{r,echo=FALSE,fig.width= 12, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag = "five_uncorrelated_tissues_three_omics"
plot_Prior(results_dir,runtag,paste(1, 1:10, sep = "-"),c(1),"shared_all","ctwas",".minp08.mingene0.parameters.RDS",prior_true)
```

### Enrichment
```{r,echo=FALSE,fig.width= 12, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag = "five_uncorrelated_tissues_three_omics"
plot_enrichment(results_dir,runtag,paste(1, 1:10, sep = "-"),c(1),"shared_all","ctwas",".minp08.mingene0.parameters.RDS",enrichment_true)
```

## PVE
```{r,echo=FALSE,fig.width= 12, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag = "five_uncorrelated_tissues_three_omics"
plot_PVE(results_dir,runtag,paste(1, 1:10, sep = "-"),c(1),"shared_all","ctwas",".minp08.mingene0.parameters.RDS",pve_true)
```

## PHE
```{r,echo=FALSE,fig.width= 12, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag = "five_uncorrelated_tissues_three_omics"
plot_PHE(results_dir,runtag,paste(1, 1:10, sep = "-"),c(1),"shared_all","ctwas",".minp08.mingene0.parameters.RDS",phe_true)
```

## Inflated single group PHE
```{r,echo=FALSE,fig.width= 12, fig.height= 4}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag_list <- c(paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_expression"),
                  paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_splicing"),
                 paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_stability"))
plot_single_PHE(results_dir,runtag_list,c(1),phe_true)
```

## Molecular level PIP
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=4, fig.height=4}
molecular_PIPs <- list()
for(i in c(1)){
  print(i)
  f1 <- plot_molecular_PIPs(results_dir, runtag, paste(1, 1:10, sep = "-"), i, "shared_all", "ctwas", ".minp08.mingene0.estimated_parameter.finemap_regions_res.RDS", main = paste0("thin ",i))
  molecular_PIPs[[as.character(i)]] <- f1
}
do.call(grid.arrange, c(molecular_PIPs, ncol = 1))
```

## Gene level PIP
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=4, fig.height=4}
mapping_table1 <- readRDS("/project2/xinhe/shared_data/multigroup_ctwas/weights/mapping_files/PredictDB_mapping.RDS")
mapping_table2 <- readRDS("/project2/xinhe/shared_data/multigroup_ctwas/weights/mapping_files/Munro_mapping.RDS")
mapping_table <- rbind(mapping_table1,mapping_table2)
simutags <- list("group1"=  paste(1, 1:10, sep = "-"))
gene_PIPs <- list()
for(i in c(1)){
  print(i)
  f1 <- plot_gene_PIPs(results_dir, runtag, paste(1, 1:10, sep = "-"), i, "shared_all", "ctwas", mapping_table, ".minp08.mingene0.estimated_parameter.finemap_regions_res.RDS", main = paste0("thin ",i))
  gene_PIPs[[as.character(i)]] <- f1
}
do.call(grid.arrange, c(gene_PIPs, ncol = 1))
```

## Multi-cTWAS increases power of identifying causal molecular traits
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=6, fig.height=6}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag1 <- "five_uncorrelated_tissues_three_omics"
runtag2 <- "Liver_expression"
plot_molecular_power_compare_group(results_dir,runtag1,runtag2,c(1))
```

## Multi-cTWAS increases power of identifying causal genes
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=6, fig.height=6}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag1 <- "five_uncorrelated_tissues_three_omics"
runtag2 <- "Liver_expression"
plot_gene_power_compare_group(results_dir,runtag1,runtag2,c(1),mapping_table)
```

## Multi-cTWAS reduces false positive rate on molecular level
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=8, fig.height=6}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag1 <- "five_uncorrelated_tissues_three_omics"
runtag_list1 <- c(paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_expression"),
                  paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_splicing"),
                  paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_stability"))

runtag_list2 <- c(paste0("expression_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")),
                  paste0("splicing_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")),
                  paste0("stability_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")))
plot_molecular_power_compare_method(results_dir,runtag1,runtag_list1,runtag_list2,c(1))
```

## Multi-cTWAS reduces false positive rate on gene level
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=8, fig.height=6}
results_dir <- "/project/xinhe/shengqian/cTWAS_simulation/simulation_five_uncorrelated_tissues_three_omics/"
runtag1 <- "five_uncorrelated_tissues_three_omics"
runtag_list1 <- c(paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_expression"),
                  paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_splicing"),
                 paste0(c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung"),"_stability"))

runtag_list2 <- c(paste0("expression_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")),
                  paste0("splicing_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")),
                  paste0("stability_",c("Whole_Blood","Liver","Heart_Left_Ventricle","Stomach","Lung")))
plot_gene_power_compare_method(results_dir,runtag1,runtag_list1,runtag_list2,c(1),mapping_table)
```