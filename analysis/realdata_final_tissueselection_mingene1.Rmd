---
title: "Tissue selection -- min gene 1"
author: "XSun"
date: "2025-05-14"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

For each non-psychiatric trait, we conducted a single eQTL cTWAS analysis jointly across all 49 GTEx tissues. For psychiatric traits, we performed a single eQTL cTWAS analysis using only the 9 GTEx brain tissues. We then ranked tissues by their G-test p-values and selected tissues that passed the Bonferroni-corrected significance threshold (0.05/total number of tissues) for inclusion in the subsequent multi-group cTWAS analysis. 

When running this selection, we used default settings for computing z-scores, assembling data and estimating parameters:

```
z_gene <- compute_gene_z(z_snp, weights, ncore=10)
```

```
res <- assemble_region_data(region_info, 
                                z_snp, 
                                z_gene, 
                                weights,
                                snp_map,
                                maxSNP = Inf,
                                min_group_size = 100,
                                thin = 1,
                                adjust_boundary_genes = TRUE,
                                ncore = 15)
```

```
param <- est_param(region_data, 
                       group_prior_var_structure = "shared_all",
                       null_method = "ctwas",
                       niter_prefit = 3,
                       min_gene = 1,
                       min_var = 2,                          
                       min_p_single_effect = 0.8,
                       niter = 80, 
                       ncore = 15,
                       verbose=TRUE)
```


```{r}
library(ctwas)
# library(ggplot2)
# library(gridExtra)

source("/project/xinhe/xsun/multi_group_ctwas/data/samplesize.R")

trait_nopsy <- c("LDL-ukb-d-30780_irnt","aFib-ebi-a-GCST006414","ATH_gtexukb","BMI-panukb","HB-panukb",
             "Height-panukb","HTN-panukb","IBD-ebi-a-GCST004131","PLT-panukb","RA-panukb","RBC-panukb",
             "SBP-ukb-a-360","T1D-GCST90014023","WBC-ieu-b-30","T2D-panukb")

trait_psy <- c("SCZ-ieu-b-5102","ASD-ieu-a-1185","BIP-ieu-b-5110","MDD-ieu-b-102","PD-ieu-b-7","ADHD-ieu-a-1183","NS-ukb-a-230")

DT::datatable(matrix())

folder_results <- "/project/xinhe/xsun/multi_group_ctwas/21.tissue_selection_0511/results/E_thin1_shared_all/"

```

# Psychiatric traits

## Tissue selection

```{r results='asis'}
converge_df <- c()
for (trait in trait_psy){
  
  param <- readRDS(paste0(folder_results,trait,"/",trait,".thin1.shared_all.param.RDS"))
  
  gwas_n <- samplesize[trait]
  param_summarized <- summarize_param(param = param,gwas_n = gwas_n,enrichment_test = "fisher",alternative = "greater")
  
  # Convert named vectors in param_summarized to a data frame
  param_df <- data.frame(
    group = names(param_summarized$group_size),
    group_size = as.numeric(param_summarized$group_size[names(param_summarized$group_size)]),
    group_pve = as.numeric(param_summarized$group_pve[names(param_summarized$group_size)]),
    prop_heritability = as.numeric(param_summarized$prop_heritability[names(param_summarized$group_size)]),
    #group_prior = as.numeric(param_summarized$group_prior[names(param_summarized$group_size)]),
    #group_prior_var = as.numeric(param_summarized$group_prior_var[names(param_summarized$group_size)]),
    log_enrichment = as.numeric(param_summarized$log_enrichment[names(param_summarized$group_size)]),
    log_enrichment_se = as.numeric(param_summarized$log_enrichment_se[names(param_summarized$group_size)]),
    enrichment_pval = as.numeric(param_summarized$enrichment_pval[names(param_summarized$group_size)])
  )

  param_df$total_pve <- param_summarized$total_pve
  
  #param_df[ , 4:ncol(param_df)] <- round(param_df[ , 4:ncol(param_df)], 5)
  param_df$prop_heritability <- paste0(round(param_df$prop_heritability * 100, 5), "%")
  
  param_df <- param_df[order(param_df$enrichment_pval,decreasing = F),]
  
  cat("<br>")
  cat(knitr::knit_print(DT::datatable(param_df, caption = htmltools::tags$caption( style = 'font-size: 40px; caption-side: topleft; text-align = left; color:black;',trait),options = list(pageLength = 10))))
  cat("<br>")
  
  threshold <- 0.05/(nrow(param_df)-1)
  
  cat("<br>")
  cat(paste0("Selected tissue:\n"))
  cat("<br>")
  param_df_qtl <- param_df[-nrow(param_df),]
  cat(paste0(
    head(param_df_qtl$group[param_df_qtl$enrichment_pval < threshold], 10), 
    collapse = " "
  ))
  cat("<br>")
  
  EM_iter <- length(param$loglik_iters)
  converge <- param$converged
  converge_df <- rbind(converge_df,c(trait,EM_iter,converge))
}

```

## EM convergence

```{r}

colnames(converge_df) <- c("trait","num_EM_iter","converge")
DT::datatable(converge_df,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','EM convergence '),options = list(pageLength = 30) )
```
