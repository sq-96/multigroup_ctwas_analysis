---
title: "PVE share pattern, tissue ranked by number of genes at PIP > 0.8"
author: "XSun"
date: "2025-08-06"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

We ranked tissues by the number of genes identified in single-tissue eQTL analyses and selected the top 10.  

From the 10 selected tissues, we obtained 45 unique tissue pairs. For each pair, we   

For each tissue pair \((A, B)\), we first estimated the PHE of tissue \(A\) when analyzed alone (in single-tissue eQTL/sQTL analysis), and then conducted both two-tissue eQTL and two-tissue sQTL analyses to estimate the PHE of each tissue in the joint analysis. 

For tissue A, \[\text{PHE}_{\text{single}}\] is the PHE from single tissue analysis,  \[\text{PHE}_{\text{joint}}\] is the PHE from 2 tissue joint analysis, we then calculated the relative change as:  


\[
\frac{\text{PHE}_{\text{single}} - \text{PHE}_{\text{joint}}}{\text{PHE}_{\text{single}}}
\]



# Results


```{r warning=F, message=F}

library(ctwas)
library(ComplexHeatmap)
library(grid)
library(circlize)

trait_nopsy <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","aFib-ebi-a-GCST006414","SBP-ukb-a-360",
                 "T1D-GCST90014023","T2D-panukb","ATH_gtexukb","BMI-panukb","HB-panukb",
                 "Height-panukb","HTN-panukb","PLT-panukb","RA-panukb","RBC-panukb",
                 "WBC-ieu-b-30"
                 )
trait_psy <- c("SCZ-ieu-b-5102","BIP-ieu-b-5110","MDD-ieu-b-102","PD-ieu-b-7",
               "NS-ukb-a-230","ASD-ieu-a-1185","ADHD-ieu-a-1183")
traits <- c(trait_nopsy,trait_psy)
#

#traits <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","SCZ-ieu-b-5102")


source("/project/xinhe/xsun/multi_group_ctwas/data/samplesize.R")

get_top_tissues <- function(trait, n_top = 10, folder_results) {
 
  
  # Find files matching pattern
  finalfiles <- list.files(folder_results, pattern = "_csinclude")
  
  # Collect tissue summaries
  trait_sum <- do.call(rbind, lapply(finalfiles, function(file) {
    gene_pip <- readRDS(file.path(folder_results, file))
    
    tissue <- gsub(pattern = paste0(trait, "_"), replacement = "", x = file)
    tissue <- gsub(pattern = ".combined_pip_bygroup_final_csinclude.RDS", replacement = "", x = tissue)
    
    data.frame(tissue = tissue,
               num_gene_pip08 = sum(gene_pip$combined_pip > 0.8),
               stringsAsFactors = FALSE)
  }))
  
  # Filter, order, and select top tissues
  
  # trait_sum <- trait_sum[trait_sum$num_gene_pip08 > 0, ]
  trait_sum <- trait_sum[order(trait_sum$num_gene_pip08, decreasing = TRUE), ]
  
  # Return top tissues
  head(trait_sum$tissue, n_top)
}



```


```{r fig.height=6, fig.width=10, warning=F}

#trait <- "LDL-ukb-d-30780_irnt"


for (trait  in traits){
  
  print(trait)
  
  gwas_n <- samplesize[trait]
  
  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/expression/",trait,"/")
  
  top_tissues <- get_top_tissues(
    trait = trait, 
    n_top = 10,
    folder_results = folder_results
  )
  
  
  ## single tissue eQTL
  prob_pve_alltissue <- c()
  for (tissue in top_tissues){
    
    file_param_single <- paste0(folder_results,"/",trait,"_",tissue,".thin1.shared_all.param.RDS")
    param_single <- readRDS(file_param_single)
    
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    
    prob_pve <- ctwas_parameters_single$prop_heritability[1]
    prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve)
    
  }
  
  names(prob_pve_alltissue) <- gsub(pattern = "\\|eQTL",x = names(prob_pve_alltissue), replacement = "")
  
  
  ## pairwise
  
  tissue_combination <- combn(top_tissues, 2, simplify = FALSE)
  
  mat <- matrix(NA, nrow = length(top_tissues), ncol = length(top_tissues),
                dimnames = list(top_tissues, top_tissues))
  
  for (i in 1:length(tissue_combination)){
    
    tissue1 <- tissue_combination[[i]][1]
    pve_tissue1 <- prob_pve_alltissue[tissue1]
    tissue2 <- tissue_combination[[i]][2]
    pve_tissue2 <- prob_pve_alltissue[tissue2]
    
    tissue_pair <- paste0(tissue_combination[[i]], collapse = "-")
    
    file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".eqtlonly.thin1.shared_all.param.RDS")
    param_pair <- readRDS(file_param_pair)
    ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher")
    
    pve_tissue1_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue1,"|eQTL")]
    pve_tissue2_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue2,"|eQTL")]
    
    pct_pve_shared_tissue1 <- (pve_tissue1 - pve_tissue1_joint)/pve_tissue1 * 100
    pct_pve_shared_tissue2 <- (pve_tissue2 - pve_tissue2_joint)/pve_tissue2 * 100
    
    mat[tissue1, tissue2] <- pct_pve_shared_tissue1
    mat[tissue2, tissue1] <- pct_pve_shared_tissue2
    
  
  }
  

  
  if (any(mat < 0, na.rm = TRUE)) {
    
    mat_range <- range(mat, na.rm = TRUE)  # includes negatives
    
    # create diverging color function
    col_fun <- colorRamp2(
      c(mat_range[1], 0, mat_range[2]),  # min (neg), 0, max (pos)
      c("blue", "white", "red")          # colors
    )
    
    ht1 <- Heatmap(mat,
            name = "%PVE decrease",
            cluster_rows = FALSE,
            cluster_columns = FALSE,
            col = col_fun,
            row_names_side = "left",
            column_title = paste0("%PVE decreased after \n adding the second tissue(column) -- \n", trait," (eQTL)"),
            rect_gp = gpar(col = "black", lwd = 0.5),
            cell_fun = function(j, i, x, y, width, height, fill) {
              if (!is.na(mat[i, j])) {
                grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
              }
            })
    
    
    
  }else{
    
       ht1 <- Heatmap(mat,
          name = "%PVE decrease",
          cluster_rows = FALSE,
          cluster_columns = FALSE,
          col = colorRampPalette(c("white", "red"))(100),
          row_names_side = "left",   # can also be "right"
          column_title = paste0("%PVE decreased after  \n adding the second tissue(column) -- \n", trait," (eQTL)"),
          rect_gp = gpar(col = "black", lwd = 0.5),   # draw grid lines
          cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
          })
    
  }

  
  
  
  ## single tissue sQTL
  
  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/splicing/",trait,"/")
  
  prob_pve_alltissue <- c()
  for (tissue in top_tissues){
    
    file_param_single <- paste0(folder_results,"/",trait,"_",tissue,".thin1.shared_all.param.RDS")
    param_single <- readRDS(file_param_single)
    
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    
    prob_pve <- ctwas_parameters_single$prop_heritability[1]
    prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve)
    
  }
  
  names(prob_pve_alltissue) <- gsub(pattern = "\\|sQTL",x = names(prob_pve_alltissue), replacement = "")
  
  
  for (i in 1:length(tissue_combination)){
    
    tissue1 <- tissue_combination[[i]][1]
    pve_tissue1 <- prob_pve_alltissue[tissue1]
    tissue2 <- tissue_combination[[i]][2]
    pve_tissue2 <- prob_pve_alltissue[tissue2]
    
    tissue_pair <- paste0(tissue_combination[[i]], collapse = "-")
    
    file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".sqtlonly.thin1.shared_all.param.RDS")
    param_pair <- readRDS(file_param_pair)
    ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher")
    
    pve_tissue1_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue1,"|sQTL")]
    pve_tissue2_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue2,"|sQTL")]
    
    pct_pve_shared_tissue1 <- (pve_tissue1 - pve_tissue1_joint)/pve_tissue1 * 100
    pct_pve_shared_tissue2 <- (pve_tissue2 - pve_tissue2_joint)/pve_tissue2 * 100
    
    mat[tissue1, tissue2] <- pct_pve_shared_tissue1
    mat[tissue2, tissue1] <- pct_pve_shared_tissue2
    
  
  }
  

  if (any(mat < 0, na.rm = TRUE)) {
    
    mat_range <- range(mat, na.rm = TRUE)  # includes negatives
    
    # create diverging color function
    col_fun <- colorRamp2(
      c(mat_range[1], 0, mat_range[2]),  # min (neg), 0, max (pos)
      c("blue", "white", "red")          # colors
    )
    
    ht2 <- Heatmap(mat,
            name = "%PVE decrease",
            cluster_rows = FALSE,
            cluster_columns = FALSE,
            col = col_fun,
            row_names_side = "left",
            column_title = paste0("%PVE decreased after \n adding the second tissue(column) -- \n", trait," (sQTL)"),
            rect_gp = gpar(col = "black", lwd = 0.5),
            cell_fun = function(j, i, x, y, width, height, fill) {
              if (!is.na(mat[i, j])) {
                grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
              }
            })
    
    
    
  }else{
    
       ht2 <- Heatmap(mat,
          name = "%PVE decrease",
          cluster_rows = FALSE,
          cluster_columns = FALSE,
          col = colorRampPalette(c("white", "red"))(100),
          row_names_side = "left",   # can also be "right"
          column_title = paste0("%PVE decreased after  \n adding the second tissue(column) -- \n", trait," (sQTL)"),
          rect_gp = gpar(col = "black", lwd = 0.5),   # draw grid lines
          cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
          })
    
  }
  

  
  
  draw(ht1 + ht2)
  
}





```







<!-- ```{r fig.height=8, fig.width=8} -->

<!-- #trait <- "LDL-ukb-d-30780_irnt" -->


<!-- for (trait  in traits){ -->

<!--   gwas_n <- samplesize[trait] -->

<!--   folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/expression/",trait,"/") -->

<!--   top_tissues <- get_top_tissues( -->
<!--     trait = trait,  -->
<!--     n_top = 10, -->
<!--     folder_results = folder_results -->
<!--   ) -->


<!--   ## single tissue eQTL -->
<!--   prob_pve_alltissue <- c() -->
<!--   for (tissue in top_tissues){ -->

<!--     file_param_single <- paste0(folder_results,"/",trait,"_",tissue,".thin1.shared_all.param.RDS") -->
<!--     param_single <- readRDS(file_param_single) -->

<!--     ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher") -->

<!--     prob_pve <- ctwas_parameters_single$prop_heritability[1] -->
<!--     prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve) -->

<!--   } -->

<!--   names(prob_pve_alltissue) <- gsub(pattern = "\\|eQTL",x = names(prob_pve_alltissue), replacement = "") -->


<!--   ## pairwise -->

<!--   tissue_combination <- combn(top_tissues, 2, simplify = FALSE) -->

<!--   prob_pve_shared_all <- c() -->
<!--   for (i in 1:length(tissue_combination)){ -->

<!--     tissue1 <- tissue_combination[[i]][1] -->
<!--     pve_tissue1 <- prob_pve_alltissue[tissue1] -->
<!--     tissue2 <- tissue_combination[[i]][2] -->
<!--     pve_tissue2 <- prob_pve_alltissue[tissue2] -->

<!--     tissue_pair <- paste0(tissue_combination[[i]], collapse = "-") -->

<!--     file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".eqtlonly.thin1.shared_all.param.RDS") -->
<!--     param_pair <- readRDS(file_param_pair) -->
<!--     ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher") -->
<!--     prob_pve_sum <- ctwas_parameters_pair$prop_heritability[1] + ctwas_parameters_pair$prop_heritability[2]  -->

<!--     prob_pve_shared <- (pve_tissue1 + pve_tissue2 - prob_pve_sum)/pve_tissue1 -->
<!--     names(prob_pve_shared) <- tissue_pair -->
<!--     prob_pve_shared_all <-c(prob_pve_shared_all,prob_pve_shared) -->
<!--   } -->


<!--   mat <- matrix(NA, nrow = length(top_tissues), ncol = length(top_tissues), -->
<!--                 dimnames = list(top_tissues, top_tissues)) -->

<!--   if(length( grep(pattern = "Brain_Spinal_cord_cervical_c-1", x = names(prob_pve_shared_all)) ) >0) { -->

<!--     for (n in names(prob_pve_shared_all)) { -->
<!--       # split at the hyphen that is followed by "Brain_" -->
<!--       parts <- strsplit(n, "-(?=Brain_)", perl = TRUE)[[1]] -->

<!--       mat[parts[1], parts[2]] <- prob_pve_shared_all[[n]] -->
<!--       mat[parts[2], parts[1]] <- prob_pve_shared_all[[n]]  # symmetric -->
<!--     } -->

<!--   }else { -->

<!--     for (n in names(prob_pve_shared_all)) { -->
<!--       parts <- strsplit(n, "-")[[1]] -->
<!--       mat[parts[1], parts[2]] <- prob_pve_shared_all[n] -->
<!--       mat[parts[2], parts[1]] <- prob_pve_shared_all[n]  # symmetric -->
<!--     } -->

<!--   } -->


<!--   # Assuming your matrix is called 'mat' -->
<!--   # Fill diagonal with 1 for self-comparison -->
<!--   diag(mat) <- NA -->

<!--   # Create heatmap -->
<!--   pheatmap(mat,  -->
<!--            cluster_rows = F,  -->
<!--            cluster_cols = F,  -->
<!--            display_numbers = TRUE,   # optional, shows the values -->
<!--            color = colorRampPalette(c("white", "red"))(100), -->
<!--            main = paste0("Shared PVE between tissues (eQTL) --", trait)) -->


<!--   ## single tissue sQTL -->

<!--   prob_pve_alltissue <- c() -->
<!--   for (tissue in top_tissues){ -->

<!--     file_param_single <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/splicing/",trait,"/",trait,"_",tissue,".thin1.shared_all.param.RDS") -->
<!--     param_single <- readRDS(file_param_single) -->

<!--     ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher") -->

<!--     prob_pve <- ctwas_parameters_single$prop_heritability[1] -->
<!--     prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve) -->

<!--   } -->

<!--   names(prob_pve_alltissue) <- gsub(pattern = "\\|sQTL",x = names(prob_pve_alltissue), replacement = "") -->


<!--   ## pairwise -->

<!--   tissue_combination <- combn(top_tissues, 2, simplify = FALSE) -->

<!--   prob_pve_shared_all <- c() -->
<!--   for (i in 1:length(tissue_combination)){ -->

<!--     tissue1 <- tissue_combination[[i]][1] -->
<!--     pve_tissue1 <- prob_pve_alltissue[tissue1] -->
<!--     tissue2 <- tissue_combination[[i]][2] -->
<!--     pve_tissue2 <- prob_pve_alltissue[tissue2] -->

<!--     tissue_pair <- paste0(tissue_combination[[i]], collapse = "-") -->

<!--     file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".sqtlonly.thin1.shared_all.param.RDS") -->
<!--     param_pair <- readRDS(file_param_pair) -->
<!--     ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher") -->
<!--     prob_pve_sum <- ctwas_parameters_pair$prop_heritability[1] + ctwas_parameters_pair$prop_heritability[2]  -->

<!--     prob_pve_shared <- pve_tissue1 + pve_tissue2 - prob_pve_sum -->
<!--     names(prob_pve_shared) <- tissue_pair -->
<!--     prob_pve_shared_all <-c(prob_pve_shared_all,prob_pve_shared) -->
<!--   } -->


<!--   mat <- matrix(NA, nrow = length(top_tissues), ncol = length(top_tissues), -->
<!--                 dimnames = list(top_tissues, top_tissues)) -->

<!--   # Fill in the values -->
<!--   if(length( grep(pattern = "Brain_Spinal_cord_cervical_c-1", x = names(prob_pve_shared_all)) ) >0) { -->

<!--     for (n in names(prob_pve_shared_all)) { -->
<!--       # split at the hyphen that is followed by "Brain_" -->
<!--       parts <- strsplit(n, "-(?=Brain_)", perl = TRUE)[[1]] -->

<!--       mat[parts[1], parts[2]] <- prob_pve_shared_all[[n]] -->
<!--       mat[parts[2], parts[1]] <- prob_pve_shared_all[[n]]  # symmetric -->
<!--     } -->

<!--   }else { -->

<!--     for (n in names(prob_pve_shared_all)) { -->
<!--       parts <- strsplit(n, "-")[[1]] -->
<!--       mat[parts[1], parts[2]] <- prob_pve_shared_all[n] -->
<!--       mat[parts[2], parts[1]] <- prob_pve_shared_all[n]  # symmetric -->
<!--     } -->

<!--   } -->


<!--   # Assuming your matrix is called 'mat' -->
<!--   # Fill diagonal with 1 for self-comparison -->
<!--   diag(mat) <- NA -->

<!--   # Create heatmap -->
<!--   pheatmap(mat,  -->
<!--            cluster_rows = F,  -->
<!--            cluster_cols = F,  -->
<!--            display_numbers = TRUE,   # optional, shows the values -->
<!--            color = colorRampPalette(c("white", "red"))(100), -->
<!--            main = paste0("Shared PVE between tissues (sQTL) --", trait)) -->




<!-- } -->





<!-- ``` -->