---
title: "6 Traits, 5 tissues, eQTL + sQTL + stQTL â€“ compute ukbb LD, eqtl, sqtl from predictdb; stQTL from Munro et al; post-processing, comparing 2 LD mismatch approaches, problematic genes filtered by PIP + zscore >3"
author: "XSun"
date: "2024-12-17"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

We compare post-processed results with the original results: https://sq-96.github.io/multigroup_ctwas_analysis/multi_group_6traits_15weights_ess.html

The post-processing steps include the following:

1. **Region Merging**  

   For the regions with `susie_pip > 0.5` 
   
2. **LD Mismatch Fixing**

-   Regions were selected where nonSNP_PIP > 0.5.
-   For genes with `susie_pip > thresholds` (0.5 and 0.2), we performed LD mismatch diagnosis.
-   To address LD mismatches, two strategies were employed:
    -   Fine-mapping the region without LD.
    -   Removing mismatched SNPs for all genes in the problematic regions, updating gene Z-scores, re-estimated L, and re-fine-mapping with LD.
    
The problematic regions here are the regions 1) reported by `diagnose_LD_mismatch_susie` function & 2) containing at least 1 problematic genes reported by `get_problematic_genes` function.
    

```{r message=FALSE, warning=FALSE}
library(ctwas)
library(EnsDb.Hsapiens.v86)
library(ggplot2)
library(gridExtra)
library(dplyr)

ens_db <- EnsDb.Hsapiens.v86

mapping_predictdb <- readRDS("/project2/xinhe/shared_data/multigroup_ctwas/weights/mapping_files/PredictDB_mapping.RDS")
mapping_munro <- readRDS("/project2/xinhe/shared_data/multigroup_ctwas/weights/mapping_files/Munro_mapping.RDS")
mapping_two <- rbind(mapping_predictdb,mapping_munro)

```


# aFib-ebi-a-GCST006414

```{r message=FALSE, warning=FALSE}
trait <- "aFib-ebi-a-GCST006414"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)

grid.arrange(p1,p2,p3,p4, ncol = 4)

```



## Examples for LD-mismatch fixing


```{r message=FALSE, warning=FALSE, fig.width=12, fig.height=9}
weights_origin <- readRDS(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/",trait,".preprocessed.weights.RDS"))

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_weights_updated_",trait,".rdata"))

region_id <- "3_110794923_113096852"

finemap_res_rm <- anno_finemap_res(finemap_res_rm,
                                          snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                          mapping_table = mapping_two,
                                          add_gene_annot = TRUE,
                                          map_by = "molecular_id",
                                          drop_unmapped = TRUE,
                                          add_position = TRUE,
                                          use_gene_pos = "mid")

finemap_res_ldmm_nold <- anno_finemap_res(finemap_res_ldmm_nold,
                                          snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                          mapping_table = mapping_two,
                                          add_gene_annot = TRUE,
                                          map_by = "molecular_id",
                                          drop_unmapped = TRUE,
                                          add_position = TRUE,
                                          use_gene_pos = "mid")

finemap_res_ldmm_removesnp <- anno_finemap_res(finemap_res_ldmm_removesnp,
                                   snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                   mapping_table = mapping_two,
                                   add_gene_annot = TRUE,
                                   map_by = "molecular_id",
                                   drop_unmapped = TRUE,
                                   add_position = TRUE,
                                   use_gene_pos = "mid")

finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]


print("locus plot -- after region merge")
make_locusplot(finemap_res_rm,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: no LD")

make_locusplot(finemap_res_ldmm_nold,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: snp removed")
make_locusplot(finemap_res_ldmm_removesnp,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_updated,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


finemap_res_rm_gene_region <- finemap_res_rm_gene[finemap_res_rm_gene$region_id == region_id,]
finemap_res_ldmm_removesnp_gene_region <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$region_id == region_id,]
merged_region_gene <- merge(finemap_res_rm_gene_region,finemap_res_ldmm_removesnp_gene_region,by = "id")
merged_region_gene <- merged_region_gene[,c("id","gene_name.x","z.x","susie_pip.x","cs.x","z.y","susie_pip.y","cs.y")]
colnames(merged_region_gene) <- c("id","gene_name","z_regionmerge","susie_pip_regionmerge","cs_regionmerge","z_ldmismatch","susie_pip_ldmismatch","cs_ldmismatch")

merged_region_gene$highlight <- ifelse(merged_region_gene$id %in% problematic_genes, "problematic genes", "good genes")

ggplot(data = merged_region_gene, aes(x= z_regionmerge, y= z_ldmismatch, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.3)) +
  ggtitle("Comparing z-scores before/after removing the problematic SNPs") +
  theme_minimal()

DT::datatable(merged_region_gene[merged_region_gene$z_ldmismatch != merged_region_gene$z_regionmerge,],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Genes with different z before / after removing the problematic SNPs'),options = list(pageLength = 10) )

```

# LDL-ukb-d-30780_irnt

```{r message=FALSE, warning=FALSE}
trait <- "LDL-ukb-d-30780_irnt"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)

grid.arrange(p1,p2,p3,p4, ncol = 4)

```



# IBD-ebi-a-GCST004131

```{r message=FALSE, warning=FALSE}
trait <- "IBD-ebi-a-GCST004131"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)

grid.arrange(p1,p2,p3,p4, ncol = 4)

```



# SBP-ukb-a-360

```{r message=FALSE, warning=FALSE}
trait <- "SBP-ukb-a-360"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch 
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) + 
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +  
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") + 
  geom_abline(slope = 1, intercept = 0, col = "red") + 
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) + 
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") + 
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +  
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") + 
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) + 
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") + 
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") + 
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) + 
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) + 
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) + 
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) + 
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob, 
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) + 
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob, 
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) + 
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob, 
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) + 
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob, 
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) + 
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)
  
grid.arrange(p1,p2,p3,p4, ncol = 4)

```



## Examples for LD-mismatch fixing


```{r message=FALSE, warning=FALSE, fig.width=12, fig.height=9}
weights_origin <- readRDS(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/",trait,".preprocessed.weights.RDS"))

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_weights_updated_",trait,".rdata"))



finemap_res_rm <- anno_finemap_res(finemap_res_rm,
                                          snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                          mapping_table = mapping_two,
                                          add_gene_annot = TRUE,
                                          map_by = "molecular_id",
                                          drop_unmapped = TRUE,
                                          add_position = TRUE,
                                          use_gene_pos = "mid")

finemap_res_ldmm_nold <- anno_finemap_res(finemap_res_ldmm_nold,
                                          snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                          mapping_table = mapping_two,
                                          add_gene_annot = TRUE,
                                          map_by = "molecular_id",
                                          drop_unmapped = TRUE,
                                          add_position = TRUE,
                                          use_gene_pos = "mid")

finemap_res_ldmm_removesnp <- anno_finemap_res(finemap_res_ldmm_removesnp,
                                   snp_map = updated_data_res_regionmerge[["updated_snp_map"]],
                                   mapping_table = mapping_two,
                                   add_gene_annot = TRUE,
                                   map_by = "molecular_id",
                                   drop_unmapped = TRUE,
                                   add_position = TRUE,
                                   use_gene_pos = "mid")

finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]

region_id <- "11_1192365_3644251"

print("locus plot -- after region merge")
make_locusplot(finemap_res_rm,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: no LD")

make_locusplot(finemap_res_ldmm_nold,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: snp removed")
make_locusplot(finemap_res_ldmm_removesnp,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_updated,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


finemap_res_rm_gene_region <- finemap_res_rm_gene[finemap_res_rm_gene$region_id == region_id,]
finemap_res_ldmm_removesnp_gene_region <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$region_id == region_id,]
merged_region_gene <- merge(finemap_res_rm_gene_region,finemap_res_ldmm_removesnp_gene_region,by = "id")
merged_region_gene <- merged_region_gene[,c("id","gene_name.x","z.x","susie_pip.x","cs.x","z.y","susie_pip.y","cs.y")]
colnames(merged_region_gene) <- c("id","gene_name","z_regionmerge","susie_pip_regionmerge","cs_regionmerge","z_ldmismatch","susie_pip_ldmismatch","cs_ldmismatch")

merged_region_gene$highlight <- ifelse(merged_region_gene$id %in% problematic_genes, "problematic genes", "good genes")

ggplot(data = merged_region_gene, aes(x= z_regionmerge, y= z_ldmismatch, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.3)) +
  ggtitle("Comparing z-scores before/after removing the problematic SNPs") +
  theme_minimal()

DT::datatable(merged_region_gene[merged_region_gene$z_ldmismatch != merged_region_gene$z_regionmerge,],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Genes with different z before / after removing the problematic SNPs'),options = list(pageLength = 10) )


region_id <- "16_3951195_5068344"

print("locus plot -- after region merge")
make_locusplot(finemap_res_rm,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: no LD")

make_locusplot(finemap_res_ldmm_nold,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_origin,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


print("locus plot -- LD mismatch: snp removed")
make_locusplot(finemap_res_ldmm_removesnp,
               region_id = region_id,
               ens_db = ens_db,
               weights = weights_updated,
               highlight_pip = 0.8,
               filter_protein_coding_genes = TRUE,
               filter_cs = TRUE,
               color_pval_by = "cs",
               color_pip_by = "cs",panel.heights = c(4,4,1,1))


finemap_res_rm_gene_region <- finemap_res_rm_gene[finemap_res_rm_gene$region_id == region_id,]
finemap_res_ldmm_removesnp_gene_region <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$region_id == region_id,]
merged_region_gene <- merge(finemap_res_rm_gene_region,finemap_res_ldmm_removesnp_gene_region,by = "id")
merged_region_gene <- merged_region_gene[,c("id","gene_name.x","z.x","susie_pip.x","cs.x","z.y","susie_pip.y","cs.y")]
colnames(merged_region_gene) <- c("id","gene_name","z_regionmerge","susie_pip_regionmerge","cs_regionmerge","z_ldmismatch","susie_pip_ldmismatch","cs_ldmismatch")

merged_region_gene$highlight <- ifelse(merged_region_gene$id %in% problematic_genes, "problematic genes", "good genes")

ggplot(data = merged_region_gene, aes(x= z_regionmerge, y= z_ldmismatch, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.3)) +
  ggtitle("Comparing z-scores before/after removing the problematic SNPs") +
  theme_minimal()

DT::datatable(merged_region_gene[merged_region_gene$z_ldmismatch != merged_region_gene$z_regionmerge,],caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Genes with different z before / after removing the problematic SNPs'),options = list(pageLength = 10) )


```





# SCZ-ieu-b-5102

```{r message=FALSE, warning=FALSE}
trait <- "SCZ-ieu-b-5102"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)

grid.arrange(p1,p2,p3,p4, ncol = 4)

```



# WBC-ieu-b-30

```{r message=FALSE, warning=FALSE}
trait <- "WBC-ieu-b-30"

results_dir_origin <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/results/",trait,"/")
ctwas_res_origin <- readRDS(paste0(results_dir_origin,trait,".ctwas.res.RDS"))

finemap_res_origin <- ctwas_res_origin$finemap_res
```

## Region merge

```{r message=FALSE, warning=FALSE}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/rm_",trait,".rdata"))

finemap_res_rm <- res_regionmerge$finemap_res
finemap_res_rm_boundary_genes <- finemap_res_rm[finemap_res_rm$id %in%selected_boundary_genes$id,]
finemap_res_rm_boundary_genes_pip <- finemap_res_rm_boundary_genes[,c("id","susie_pip","cs")]


finemap_res_origin_boundary_genes <- finemap_res_origin[finemap_res_origin$id %in%selected_boundary_genes$id,]
finemap_res_origin_boundary_genes_pip <- finemap_res_origin_boundary_genes[,c("id","susie_pip","cs")]

finemap_res_compare_regionmerge <- merge(finemap_res_origin_boundary_genes_pip,finemap_res_rm_boundary_genes_pip, by = "id")
colnames(finemap_res_compare_regionmerge) <- c("id","susie_pip_origin","cs_origin","susie_pip_reginmerge","cs_reginmerge")

DT::datatable(finemap_res_compare_regionmerge,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Selected boundary genes (susie_pip > 0.5)'),options = list(pageLength = 10) )
```

## LD-mismatch
### Diagnosis

```{r message=FALSE, warning=FALSE}

file_pipthreshold02 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres02_", trait, ".rdata")

load(file_pipthreshold02)
pip_02 <- data.frame(
  "PIP Threshold" = "0.2",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)


file_pipthreshold05 <- paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_diagnosis_pipthres05_", trait, ".rdata")

load(file_pipthreshold05)
pip_05 <- data.frame(
  "PIP Threshold" = "0.5",
  "Number of Selected Regions" = length(selected_region_ids),
  "Number of Problematic Genes" = length(problematic_genes),
  "Number of Problematic Regions" = length(problematic_region_ids),
  "Number of Problematic SNPs" = length(res_ldmismatch$problematic_snps),
  "Number of Flipped SNPs" = length(res_ldmismatch$flipped_snps)
)

results_table <- rbind(pip_02, pip_05)

DT::datatable(results_table,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','LD mismatch diagnosis table for different gene cutoff'),options = list(pageLength = 10) )

```

### Comparing 2 LD mismatch fixing methods

```{r message=FALSE, warning=FALSE, fig.width=14, fig.height=4}

load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_nold_",trait,".rdata"))
finemap_res_ldmm_nold <- res_ldmm_nold$finemap_res
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres02_removesnp_",trait,".rdata"))
finemap_res_ldmm_removesnp <- res_ldmm_removesnp$finemap_res

finemap_res_ldmm_nold_problematic_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$region_id %in% problematic_region_ids & finemap_res_ldmm_nold$type != "SNP",]
finemap_res_ldmm_removesnp_problematic_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$region_id %in% problematic_region_ids & finemap_res_ldmm_removesnp$type != "SNP",]

merge_2method <- merge(finemap_res_ldmm_nold_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x=T)
merge_2method$highlight <- ifelse(merge_2method$id %in% problematic_genes, "problematic genes", "good genes")
merge_2method$susie_pip.y[is.na(merge_2method$susie_pip.y)] <- 1.5
p1 <- ggplot(data = merge_2method, aes(x = susie_pip.x, y = susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  labs(x = "PIP_noLD", y = "PIP_removesnp") +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  ggtitle("Problematic regions only, genes only") +
  theme_minimal()

finemap_res_rm_problematic_gene <- finemap_res_rm[finemap_res_rm$region_id %in% problematic_region_ids & finemap_res_rm$type != "SNP",]

merge_rm_ldmm_nold <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_nold_problematic_gene, by ="id",all.x=T)
merge_rm_ldmm_nold$highlight <- ifelse(merge_rm_ldmm_nold$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_nold$susie_pip.y[is.na(merge_rm_ldmm_nold$susie_pip.y)] <- 1.5
p2 <- ggplot(data = merge_rm_ldmm_nold, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_noLD") +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()

merge_rm_ldmm_removesnp <-  merge(finemap_res_rm_problematic_gene,finemap_res_ldmm_removesnp_problematic_gene, by ="id",all.x =T)
merge_rm_ldmm_removesnp$highlight <- ifelse(merge_rm_ldmm_removesnp$id %in% problematic_genes, "problematic genes", "good genes")
merge_rm_ldmm_removesnp$susie_pip.y[is.na(merge_rm_ldmm_removesnp$susie_pip.y)] <- 1.5
p3 <- ggplot(data = merge_rm_ldmm_removesnp, aes(x= susie_pip.x, y= susie_pip.y, color = highlight, alpha = highlight)) +
  geom_point() +
  labs(x="PIP_after_regionmerge", y="PIP_removesnp") +
  scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.1)) +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  geom_abline(slope = 1, intercept = 0, col ="red") +
  ggtitle("problematic regions only, genes only") +
  theme_minimal()
print(sprintf("Total genes in problematic regions = %s",nrow(merge_rm_ldmm_removesnp)))
print(sprintf("Number of genes disappeared after removing prblematic SNPs = %s", sum(merge_rm_ldmm_removesnp$susie_pip.y == 1.5)))

finemap_res_rm_problematic_gene$highlight <- ifelse(finemap_res_rm_problematic_gene$id %in% problematic_genes, "problematic genes", "good genes")
print(sprintf("The number of problematic genes with PIP < 0.01 = %s",sum(finemap_res_rm_problematic_gene$highlight == "problematic genes" & finemap_res_rm_problematic_gene$susie_pip < 0.01)))
print("The dots showing PIP =1.5 means: these genes were removed since the only QTLs of them are problematic")
grid.arrange(p1,p2,p3, ncol = 3)


```

## Comparing z-scores and susie_pip

```{r message=FALSE, warning=FALSE,fig.width=17, fig.height=4}

finemap_res_origin <- ctwas_res_origin$finemap_res
finemap_res_origin_gene <- finemap_res_origin[finemap_res_origin$type != "SNP",]
finemap_res_origin_gene$highlight <- ifelse(finemap_res_origin_gene$id %in% problematic_genes, "problematic genes", "good genes")

p1 <- ggplot(data = finemap_res_origin_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("Original ctwas results") +
  theme_minimal()


finemap_res_rm_gene <- finemap_res_rm[finemap_res_rm$type != "SNP",]
finemap_res_rm_gene$highlight <- ifelse(finemap_res_rm_gene$id %in% problematic_genes, "problematic genes", "good genes")

p2 <- ggplot(data = finemap_res_rm_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After region merge") +
  theme_minimal()


finemap_res_ldmm_nold_gene <- finemap_res_ldmm_nold[finemap_res_ldmm_nold$type !="SNP",]
finemap_res_ldmm_nold_gene$highlight <- ifelse(finemap_res_ldmm_nold_gene$id %in% problematic_genes, "problematic genes", "good genes")

p3 <- ggplot(data = finemap_res_ldmm_nold_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- noLD") +
  theme_minimal()

finemap_res_ldmm_removesnp_gene <- finemap_res_ldmm_removesnp[finemap_res_ldmm_removesnp$type !="SNP",]
finemap_res_ldmm_removesnp_gene$highlight <- ifelse(finemap_res_ldmm_removesnp_gene$id %in% problematic_genes, "problematic genes", "good genes")

p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene, aes(x= abs(z), y= susie_pip, color = highlight)) +
  geom_point() +
  scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
  ggtitle("After LD mismatch fixed -- SNP removed") +
  theme_minimal()


grid.arrange(p1,p2,p3,p4, ncol = 4)

print("L - estimated in region merge step")
print(updated_data_res_regionmerge$updated_region_L[problematic_region_ids])
load(paste0("/project/xinhe/xsun/multi_group_ctwas/11.multi_group_1008/post_process_rm_ld/ldmismatch_pipthres05_removesnp_rescreenregion_",trait,".rdata"))
print("L - re-estimated after updating z_scores, region data")
print(screen_res$screened_region_L)

print("Zoom in the z<15 part")

finemap_res_origin_gene_prob <- finemap_res_origin_gene[finemap_res_origin_gene$highlight == "problematic genes",]
p1 <- ggplot(data = finemap_res_origin_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("Original ctwas results") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_rm_gene_prob <- finemap_res_rm_gene[finemap_res_rm_gene$highlight == "problematic genes",]
p2 <- ggplot(data = finemap_res_rm_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After region merge") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_nold_gene_prob <- finemap_res_ldmm_nold_gene[finemap_res_ldmm_nold_gene$highlight == "problematic genes",]
p3 <- ggplot(data = finemap_res_ldmm_nold_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- noLD") +
        theme_minimal() +
        xlim(0, 15)

finemap_res_ldmm_removesnp_gene_prob <- finemap_res_ldmm_removesnp_gene[finemap_res_ldmm_removesnp_gene$highlight == "problematic genes",]
p4 <- ggplot(data = finemap_res_ldmm_removesnp_gene_prob,
        aes(x = abs(z), y = susie_pip, color = highlight, alpha = highlight)) +
        geom_point() +
        scale_color_manual(values = c("problematic genes" = "red", "good genes" = "black")) +
        scale_alpha_manual(values = c("problematic genes" = 1, "good genes" = 0.01)) +
        ggtitle("After LD mismatch fixed -- SNP removed") +
        theme_minimal() +
        xlim(0, 15)

grid.arrange(p1,p2,p3,p4, ncol = 4)

```


