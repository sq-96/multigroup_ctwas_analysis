---
title: "Validation for multi-tissue results"
author: "XSun"
date: "2024-01-11"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---


# Overview

We validate [genes with susie pip > 0.8](https://sq-96.github.io/multigroup_ctwas_analysis/multi_tissue_ldmerge.html) here. 

The basic idea is:

Some biological pathways are related to the traits. Genes within these pathways are more likely to be associated with these traits. Our approach involves aggregating these genes into a collective group. This allows us to assess whether the genes identified by cTWAS are overrepresented in this group. 

However, the presence of common genes across multiple pathways presents a challenge to this straightforward aggregation approach. To address this, we propose weighting the pathways, assigning a unique score to each gene. By selecting genes that meet a specific score threshold, we can form a more refined group. We can then evaluate the enrichment of cTWAS-identified genes within this selectively grouped set.

## Model

The model is $y=X*w$

y is an n-dimensional vector representing gene-trait associations (n = number of genes), which can be:

 - z-scores computed by MAGMA
 - a binary vector indicating gene-trait relationships (genes with FDR < 0.05 as per MAGMA are marked 1).

X is an nÃ—m matrix (m = number of pathways) indicating gene membership in specific pathways.

We fitted this model using different models.

If y is a z-score vector, it can be fitted using 

 - linear Susie
 - XGBoost: regression with squared loss

If y is a binarized vector, the model can be fitted using 

 - logistic Susie
 - XGBoost: logistic regression for binary classification, output probability

## Benchmarks

The model fitting results in pathway weights, from which we predict gene labels $\hat{y}$. We then categorize genes based on these new labels. 

- For z-score model, we compute the p-values from the new labels(z-scores), then compute FDR. Then we tested different cutoffs for gene selection. The cutoffs are: 0.05,0.1,0.2

- For binarized model. Genes with labels > 0.5/0.6/0.7/0.8 are considered benchmarks.

## Testing genes

Genes from ctwas results are divided into different groups based on their SuSiE PIPs: 

- high (>0.8) 
- moderate (0.8 > PIP > 0.5)
- low (<0.5)

## Fisher exact test

We assess whether high-PIP genes are more enriched in our benchmarks than other groups using Fisher exact tests. 

The testing matrix is: 

```{r}

fisher_matrix <- matrix(c("n1","n2","n3","n4"),nrow = 2,ncol = 2)
rownames(fisher_matrix) <- c("#included","#notincluded")
colnames(fisher_matrix) <- c("pip08","other group")

print(fisher_matrix)
```

## Pathways

The pathways are from Go Biological Process (gobp), Go Molecular Function (gomf), Go Cellular Component (gocc) and KEGG.

## Functions

```{r}

# Function to compute and display benchmark genes and overlaps
compute_gene_overlap_z <- function(threshold = 0.05) {
  traits <- c("IBD-ebi-a-GCST004131", "LDL-ukb-d-30780_irnt", "SBP-ukb-a-360", "SCZ-ieu-b-5102", "WBC-ieu-b-30", "aFib-ebi-a-GCST006414")
  folder_xgboost <- "/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/xgboost/"
  folder_susie <- "/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/susie/"

  sum <- matrix(nrow = length(traits), ncol = 3)
  for (i in seq_along(traits)) {
    xg <- get(load(paste0(folder_xgboost, "gene_labels_xgboost_", traits[i], ".rdata")))
    xg_pass <- xg$SYMBOL[xg$pred_fdr_xgb < threshold]
    xg_pass <- xg_pass[!duplicated(xg_pass)]

    susie <- get(load(paste0(folder_susie, "gene_labels_susie_", traits[i], ".rdata")))
    susie_pass <- susie$SYMBOL[susie$fdr_pred_linsusie < threshold]
    susie_pass <- susie_pass[!duplicated(susie_pass)]

    overlap <- sum(xg_pass %in% susie_pass)
    sum[i, ] <- c(length(susie_pass), length(xg_pass), overlap)
  }

  rownames(sum) <- traits
  colnames(sum) <- c("#ofbenchmarkgene_susie", "#ofbenchmarkgene_xgboost", "#ofoverlap")

  DT::datatable(sum, caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;', '#of benchmark genes and the overlaps'), options = list(pageLength = 10))
}

compute_gene_overlap_b <- function(threshold = 0.5) {
  traits <- c("IBD-ebi-a-GCST004131", "LDL-ukb-d-30780_irnt", "SBP-ukb-a-360", "SCZ-ieu-b-5102", "WBC-ieu-b-30", "aFib-ebi-a-GCST006414")
  folder_xgboost <- "/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/xgboost/"
  folder_susie <- "/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/susie/"

  sum <- matrix(nrow = length(traits), ncol = 3)
  for (i in seq_along(traits)) {
    xg <- get(load(paste0(folder_xgboost, "gene_labels_xgboost_", traits[i], ".rdata")))
    xg_pass <- xg$SYMBOL[xg$pred_y_logi_xgb > threshold]
    xg_pass <- xg_pass[!duplicated(xg_pass)]

    susie <- get(load(paste0(folder_susie, "gene_labels_susie_", traits[i], ".rdata")))
    susie_pass <- susie$SYMBOL[susie$y_pred_logi > threshold]
    susie_pass <- susie_pass[!duplicated(susie_pass)]

    overlap <- sum(xg_pass %in% susie_pass)
    sum[i, ] <- c(length(susie_pass), length(xg_pass), overlap)
  }

  rownames(sum) <- traits
  colnames(sum) <- c("#ofbenchmarkgene_susie", "#ofbenchmarkgene_xgboost", "#ofoverlap")

  DT::datatable(sum, caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;', '#of benchmark genes and the overlaps'), options = list(pageLength = 10))
}

```

# Fitting results

## Susie 

[link to the results](https://sq-96.github.io/multigroup_ctwas_analysis/multi_tissue_ldmerge_validation_susie_fit.html)


## xgboost

[link to the results](https://sq-96.github.io/multigroup_ctwas_analysis/multi_tissue_ldmerge_validation_xgboost_fit.html)

# Enrichment results (Fisher exact test)

## Susie - modelling z-scores

### FDR cutoff for selecting benchmark genes = 0.05

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/fisher_zscore_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/num_benchmark_genes_zscore_allcutoff.rdata")
# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.05)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.05)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.05) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```






### FDR cutoff for selecting benchmark genes = 0.1

```{r}

# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.1)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.1)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.1) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```



### FDR cutoff for selecting benchmark genes = 0.2

```{r}

# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.2)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.2)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.2) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


## Susie - modelling binary y

### Probability cutoff for selecting benchmark genes = 0.8

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/fisher_biny_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/num_benchmark_genes_biny_allcutoff.rdata")
# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.8)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.8)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### Probability cutoff for selecting benchmark genes = 0.7

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/fisher_biny_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/num_benchmark_genes_biny_allcutoff.rdata")
# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.7)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.7)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### Probability cutoff for selecting benchmark genes = 0.6

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/fisher_biny_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/num_benchmark_genes_biny_allcutoff.rdata")
# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.6)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.6)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### Probability cutoff for selecting benchmark genes = 0.5

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/fisher_biny_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_susie/num_benchmark_genes_biny_allcutoff.rdata")
# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.5)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.5)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.5","pip>0.8/pip<0.5","pip>0.8/pip0.8~0.5")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```




## xgboost - modelling z-scores

### FDR cutoff for selecting benchmark genes = 0.05

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_xgboost/fisher_zscore_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_xgboost/num_benchmark_genes_zscore_allcutoff.rdata")
# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.05)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.05)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.05) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### FDR cutoff for selecting benchmark genes = 0.1

```{r}

# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.1)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.1)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.1) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```



### FDR cutoff for selecting benchmark genes = 0.2

```{r}

# Convert named vectors to data frames
fisher_z_df <- as.data.frame(fisher_zscore_p$fdrcutoff_0.2)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_zscore$fdrcutoff_0.2)

# Set row names as a new column
fisher_z_df$id <- row.names(fisher_z_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_z_df,by = "id")
#colnames(merged_df_0.2) <- c("traits","#of benchmark genes","fisher_z_p_pip08+/pip08-","fisher_z_p_pip08+/pip05-","fisher_z_p_pip08+/pip05~08")
colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


## xgboost - modelling binary y

### Probability cutoff for selecting benchmark genes = 0.8

```{r}

load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_xgboost/fisher_biny_allcutoff.rdata")
load("/project/xinhe/xsun/ctwas/4.multi_tissue_process/results/fisher_xgboost/num_benchmark_genes_biny_allcutoff.rdata")
# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.8)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.8)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### Probability cutoff for selecting benchmark genes = 0.7

```{r}

# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.7)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.7)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```



### Probability cutoff for selecting benchmark genes = 0.6

```{r}

# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.6)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.6)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```


### Probability cutoff for selecting benchmark genes = 0.5

```{r}

# Convert named vectors to data frames
fisher_b_df <- as.data.frame(fisher_biny_p$probcutoff_0.5)
num_benchmark_genes_df <- as.data.frame(num_benchmark_genes_biny$probcutoff_0.5)

# Set row names as a new column
fisher_b_df$id <- row.names(fisher_b_df)
num_benchmark_genes_df$id <- row.names(num_benchmark_genes_df)

# Merge data frames by the new column
merged_df <- merge(num_benchmark_genes_df,fisher_b_df,by = "id")

colnames(merged_df) <- c("traits","#of benchmark genes","pip>0.8/pip<0.8","pip>0.8/pip<0.5","pip>0.8/pip0.5~0.8")

DT::datatable(merged_df,
             caption = htmltools::tags$caption(style = 'caption-side: left; text-align: left; color:black; font-size:150%;',
                                                  'Fisher exact test p values for different groups'),
             options = list(pageLength = 6))


```







# Benchmark gene comparison

## Modelling z-scores

### FDR cutoff for selecting benchmark genes = 0.05

```{r}

compute_gene_overlap_z(0.05)

```





### FDR cutoff for selecting benchmark genes = 0.1

```{r}

compute_gene_overlap_z(0.1)

```

### FDR cutoff for selecting benchmark genes = 0.2

```{r}

compute_gene_overlap_z(0.2)

```


## Modelling binarized y

### Probability cutoff for selecting benchmark genes = 0.8

```{r}
compute_gene_overlap_b(0.8)
```

### Probability cutoff for selecting benchmark genes = 0.7

```{r}
compute_gene_overlap_b(0.7)
```


### Probability cutoff for selecting benchmark genes = 0.6

```{r}
compute_gene_overlap_b(0.6)
```

### Probability cutoff for selecting benchmark genes = 0.5

```{r}
compute_gene_overlap_b(0.5)
```