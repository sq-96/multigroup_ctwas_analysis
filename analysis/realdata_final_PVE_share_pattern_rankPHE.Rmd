---
title: "PVE share pattern, tissue ranked by PHE"
author: "XSun"
date: "2025-08-21"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

We ranked tissues by the PHE in single-tissue eQTL analyses and selected the top 10.  

From the 10 selected tissues, we obtained 45 unique tissue pairs. For each pair, we   

For each tissue pair \((A, B)\), we first estimated the PHE of tissue \(A\) when analyzed alone (in single-tissue eQTL/sQTL analysis), and then conducted both two-tissue eQTL and two-tissue sQTL analyses to estimate the PHE of each tissue in the joint analysis. 

For tissue A, \[\text{PHE}_{\text{single}}\] is the PHE from single tissue analysis,  \[\text{PHE}_{\text{joint}}\] is the PHE from 2 tissue joint analysis, we then calculated the relative change as:  


\[
\frac{\text{PHE}_{\text{single}} - \text{PHE}_{\text{joint}}}{\text{PHE}_{\text{single}}}
\]

```{r warning=F, message=F}

library(ctwas)
library(ComplexHeatmap)
library(grid)
library(circlize)

trait_nopsy <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","aFib-ebi-a-GCST006414","SBP-ukb-a-360",
                 "T1D-GCST90014023","T2D-panukb","ATH_gtexukb","BMI-panukb","HB-panukb",
                 "Height-panukb","HTN-panukb","PLT-panukb","RA-panukb","RBC-panukb",
                 "WBC-ieu-b-30"
                 )
trait_psy <- c("SCZ-ieu-b-5102","BIP-ieu-b-5110","MDD-ieu-b-102","PD-ieu-b-7",
               "NS-ukb-a-230","ASD-ieu-a-1185","ADHD-ieu-a-1183")
traits <- c(trait_nopsy,trait_psy)
#

#traits <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","SCZ-ieu-b-5102")


source("/project/xinhe/xsun/multi_group_ctwas/data/samplesize.R")

get_top_tissues <- function(trait, n_top = 10, folder_results) {
 
  
  # Find files matching pattern
  finalfiles <- list.files(folder_results, pattern = "_csinclude")
  
  # Collect tissue summaries
  trait_sum <- do.call(rbind, lapply(finalfiles, function(file) {
    gene_pip <- readRDS(file.path(folder_results, file))
    
    tissue <- gsub(pattern = paste0(trait, "_"), replacement = "", x = file)
    tissue <- gsub(pattern = ".combined_pip_bygroup_final_csinclude.RDS", replacement = "", x = tissue)
    
    data.frame(tissue = tissue,
               num_gene_pip08 = sum(gene_pip$combined_pip > 0.8),
               stringsAsFactors = FALSE)
  }))
  
  # Filter, order, and select top tissues
  
  # trait_sum <- trait_sum[trait_sum$num_gene_pip08 > 0, ]
  trait_sum <- trait_sum[order(trait_sum$num_gene_pip08, decreasing = TRUE), ]
  
  # Return top tissues
  head(trait_sum$tissue, n_top)
}

get_top_tissues_phe <- function(trait, n_top = 10, folder_results, gwas_n) {
  
  # Find files matching pattern
  finalfiles <- list.files(folder_results, pattern = "param.RDS")
  
  # Collect tissue summaries
  trait_sum <- do.call(rbind, lapply(finalfiles, function(file) {
    param_single <- readRDS(file.path(folder_results, file))
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    phe <- ctwas_parameters_single$prop_heritability[1]
    
    tissue <- gsub(pattern = paste0(trait, "_"), replacement = "", x = file)
    tissue <- gsub(pattern = ".thin1.shared_all.param.RDS", replacement = "", x = tissue)
    
    data.frame(tissue = tissue,
               PHE_single_eQTL = phe,
               stringsAsFactors = FALSE)
  }))
  
  # Order and select top tissues
  trait_sum <- trait_sum[order(trait_sum$PHE_single_eQTL, decreasing = TRUE), ]
  
  # Return top tissues
  head(trait_sum$tissue, n_top)
}


```


# Tissue ranking 

```{r warning=F, message=F}

for (trait  in traits){
  
  print(trait)
  
  gwas_n <- samplesize[trait]
  
  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/expression/",trait,"/")
  
  top_tissues <- get_top_tissues(
    trait = trait, 
    n_top = 10,
    folder_results = folder_results
  )
 
  
  top_tissues_phe <- get_top_tissues_phe(trait, 
                                     n_top = 10, 
                                     folder_results, 
                                     gwas_n) 
  
  tissues <- cbind( top_tissues, top_tissues_phe)
  colnames(tissues) <- c("by gene number", "by PHE")  
  tissues <- as.data.frame(tissues)
  print(tissues)
}



```

