---
title: "PVE share pattern, tissue ranked by PHE"
author: "XSun"
date: "2025-08-21"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

We ranked tissues by the PHE in single-tissue eQTL analyses and selected the top 10.  

From the 10 selected tissues, we obtained 45 unique tissue pairs. For each pair, we   

For each tissue pair \((A, B)\), we first estimated the PHE of tissue \(A\) when analyzed alone (in single-tissue eQTL/sQTL analysis), and then conducted both two-tissue eQTL and two-tissue sQTL analyses to estimate the PHE of each tissue in the joint analysis. 

For tissue A, \[\text{PHE}_{\text{single}}\] is the PHE from single tissue analysis,  \[\text{PHE}_{\text{joint}}\] is the PHE from 2 tissue joint analysis, we then calculated the relative change as:  


\[
\frac{\text{PHE}_{\text{single}} - \text{PHE}_{\text{joint}}}{\text{PHE}_{\text{single}}}
\]

```{r warning=F, message=F}

library(ctwas)
library(ComplexHeatmap)
library(grid)
library(circlize)

trait_nopsy <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","aFib-ebi-a-GCST006414","SBP-ukb-a-360",
                 "T1D-GCST90014023","T2D-panukb","ATH_gtexukb","BMI-panukb","HB-panukb",
                 "Height-panukb","HTN-panukb","PLT-panukb","RA-panukb","RBC-panukb",
                 "WBC-ieu-b-30"
                 )
trait_psy <- c("SCZ-ieu-b-5102","BIP-ieu-b-5110","MDD-ieu-b-102","PD-ieu-b-7",
               "NS-ukb-a-230","ASD-ieu-a-1185","ADHD-ieu-a-1183")
traits <- c(trait_nopsy,trait_psy)
#

#traits <- c("LDL-ukb-d-30780_irnt","IBD-ebi-a-GCST004131","SCZ-ieu-b-5102")


source("/project/xinhe/xsun/multi_group_ctwas/data/samplesize.R")

get_top_tissues <- function(trait, n_top = 10, folder_results) {
 
  
  # Find files matching pattern
  finalfiles <- list.files(folder_results, pattern = "_csinclude")
  
  # Collect tissue summaries
  trait_sum <- do.call(rbind, lapply(finalfiles, function(file) {
    gene_pip <- readRDS(file.path(folder_results, file))
    
    tissue <- gsub(pattern = paste0(trait, "_"), replacement = "", x = file)
    tissue <- gsub(pattern = ".combined_pip_bygroup_final_csinclude.RDS", replacement = "", x = tissue)
    
    data.frame(tissue = tissue,
               num_gene_pip08 = sum(gene_pip$combined_pip > 0.8),
               stringsAsFactors = FALSE)
  }))
  
  # Filter, order, and select top tissues
  
  # trait_sum <- trait_sum[trait_sum$num_gene_pip08 > 0, ]
  trait_sum <- trait_sum[order(trait_sum$num_gene_pip08, decreasing = TRUE), ]
  
  # Return top tissues
  head(trait_sum$tissue, n_top)
}

get_top_tissues_phe <- function(trait, n_top = 10, folder_results, gwas_n) {
  
  # Find files matching pattern
  finalfiles <- list.files(folder_results, pattern = "param.RDS")
  
  # Collect tissue summaries
  trait_sum <- do.call(rbind, lapply(finalfiles, function(file) {
    param_single <- readRDS(file.path(folder_results, file))
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    phe <- ctwas_parameters_single$prop_heritability[1]
    
    tissue <- gsub(pattern = paste0(trait, "_"), replacement = "", x = file)
    tissue <- gsub(pattern = ".thin1.shared_all.param.RDS", replacement = "", x = tissue)
    
    data.frame(tissue = tissue,
               PHE_single_eQTL = phe,
               stringsAsFactors = FALSE)
  }))
  
  # Order and select top tissues
  trait_sum <- trait_sum[order(trait_sum$PHE_single_eQTL, decreasing = TRUE), ]
  
  # Return top tissues
  head(trait_sum$tissue, n_top)
}


```


# Tissue ranking

```{r warning=F, message=F}

for (trait  in traits){

  print(trait)

  gwas_n <- samplesize[trait]

  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/expression/",trait,"/")

  top_tissues <- get_top_tissues(
    trait = trait,
    n_top = 10,
    folder_results = folder_results
  )


  top_tissues_phe <- get_top_tissues_phe(trait,
                                     n_top = 10,
                                     folder_results,
                                     gwas_n)

  tissues <- cbind( top_tissues, top_tissues_phe)
  colnames(tissues) <- c("by gene number", "by PHE")
  tissues <- as.data.frame(tissues)
  print(tissues)
}



```


# Results

```{r fig.height=6, fig.width=10, warning=F}

#trait <- "LDL-ukb-d-30780_irnt"


for (trait  in traits){
  
  print(trait)
  
  gwas_n <- samplesize[trait]
  
  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/expression/",trait,"/")
  
  top_tissues_phe <- get_top_tissues_phe(trait,
                                     n_top = 10,
                                     folder_results,
                                     gwas_n)
  
  
  ## single tissue eQTL
  prob_pve_alltissue <- c()
  for (tissue in top_tissues_phe){
    
    file_param_single <- paste0(folder_results,"/",trait,"_",tissue,".thin1.shared_all.param.RDS")
    param_single <- readRDS(file_param_single)
    
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    
    prob_pve <- ctwas_parameters_single$prop_heritability[1]
    prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve)
    
  }
  
  names(prob_pve_alltissue) <- gsub(pattern = "\\|eQTL",x = names(prob_pve_alltissue), replacement = "")
  
  
  ## pairwise
  
  tissue_combination <- combn(top_tissues_phe, 2, simplify = FALSE)
  
  mat <- matrix(NA, nrow = length(top_tissues_phe), ncol = length(top_tissues_phe),
                dimnames = list(top_tissues_phe, top_tissues_phe))
  
  for (i in 1:length(tissue_combination)){
    
    tissue1 <- tissue_combination[[i]][1]
    pve_tissue1 <- prob_pve_alltissue[tissue1]
    tissue2 <- tissue_combination[[i]][2]
    pve_tissue2 <- prob_pve_alltissue[tissue2]
    
    tissue_pair <- paste0(tissue_combination[[i]], collapse = "-")
    
    file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".eqtlonly.thin1.shared_all.param.RDS")
    param_pair <- readRDS(file_param_pair)
    ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher")
    
    pve_tissue1_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue1,"|eQTL")]
    pve_tissue2_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue2,"|eQTL")]
    
    pct_pve_shared_tissue1 <- (pve_tissue1 - pve_tissue1_joint)/pve_tissue1 * 100
    pct_pve_shared_tissue2 <- (pve_tissue2 - pve_tissue2_joint)/pve_tissue2 * 100
    
    mat[tissue1, tissue2] <- pct_pve_shared_tissue1
    mat[tissue2, tissue1] <- pct_pve_shared_tissue2
    
  
  }
  
  prob_pve_alltissue <- prob_pve_alltissue[rownames(mat)]
  prob_pve_alltissue <- round(prob_pve_alltissue*100,digits = 2)
  
  if (any(mat < 0, na.rm = TRUE)) {
    
    mat_range <- range(mat, na.rm = TRUE)  # includes negatives
    
    # create diverging color function
    col_fun <- colorRamp2(
      c(mat_range[1], 0, mat_range[2]),  # min (neg), 0, max (pos)
      c("blue", "white", "red")          # colors
    )
    
    rownames(mat) <- paste0(rownames(mat)," ",prob_pve_alltissue,"%")
    
    ht1 <- Heatmap(mat,
            name = "%PVE decrease",
            cluster_rows = FALSE,
            cluster_columns = FALSE,
            col = col_fun,
            row_names_side = "left",
            column_title = paste0("%PVE decreased after \n adding the second tissue(column) -- \n", trait," (eQTL)"),
            rect_gp = gpar(col = "black", lwd = 0.5),
            cell_fun = function(j, i, x, y, width, height, fill) {
              if (!is.na(mat[i, j])) {
                grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
              }
            })
    
    
    
  }else{
    
    rownames(mat) <- paste0(rownames(mat)," ",prob_pve_alltissue,"%")
    
       ht1 <- Heatmap(mat,
          name = "%PVE decrease",
          cluster_rows = FALSE,
          cluster_columns = FALSE,
          col = colorRampPalette(c("white", "red"))(100),
          row_names_side = "left",   # can also be "right"
          column_title = paste0("%PVE decreased after  \n adding the second tissue(column) -- \n", trait," (eQTL)"),
          rect_gp = gpar(col = "black", lwd = 0.5),   # draw grid lines
          cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
          })
    
  }

  
  
  
  ## single tissue sQTL
  
  folder_results <- paste0("/project/xinhe/xsun/multi_group_ctwas/22.singlegroup_0515/ctwas_output/splicing/",trait,"/")
  
  prob_pve_alltissue <- c()
  for (tissue in top_tissues_phe){
    
    file_param_single <- paste0(folder_results,"/",trait,"_",tissue,".thin1.shared_all.param.RDS")
    param_single <- readRDS(file_param_single)
    
    ctwas_parameters_single <- summarize_param(param_single, gwas_n, enrichment_test = "fisher")
    
    prob_pve <- ctwas_parameters_single$prop_heritability[1]
    prob_pve_alltissue <- c(prob_pve_alltissue, prob_pve)
    
  }
  
  names(prob_pve_alltissue) <- gsub(pattern = "\\|sQTL",x = names(prob_pve_alltissue), replacement = "")
  
    mat <- matrix(NA, nrow = length(top_tissues_phe), ncol = length(top_tissues_phe),
                dimnames = list(top_tissues_phe, top_tissues_phe))
  
  for (i in 1:length(tissue_combination)){
    
    tissue1 <- tissue_combination[[i]][1]
    pve_tissue1 <- prob_pve_alltissue[tissue1]
    tissue2 <- tissue_combination[[i]][2]
    pve_tissue2 <- prob_pve_alltissue[tissue2]
    
    tissue_pair <- paste0(tissue_combination[[i]], collapse = "-")
    
    file_param_pair <- paste0("/project/xinhe/xsun/multi_group_ctwas/23.multi_group_0515/pairwise_snakemake_outputs_byPHE/",trait,"/",trait,".",tissue_pair,".sqtlonly.thin1.shared_all.param.RDS")
    param_pair <- readRDS(file_param_pair)
    ctwas_parameters_pair <- summarize_param(param_pair, gwas_n, enrichment_test = "fisher")
    
    pve_tissue1_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue1,"|sQTL")]
    pve_tissue2_joint <- ctwas_parameters_pair$prop_heritability[paste0(tissue2,"|sQTL")]
    
    pct_pve_shared_tissue1 <- (pve_tissue1 - pve_tissue1_joint)/pve_tissue1 * 100
    pct_pve_shared_tissue2 <- (pve_tissue2 - pve_tissue2_joint)/pve_tissue2 * 100
    
    mat[tissue1, tissue2] <- pct_pve_shared_tissue1
    mat[tissue2, tissue1] <- pct_pve_shared_tissue2
    
  
  }
  
  prob_pve_alltissue <- prob_pve_alltissue[rownames(mat)]
  prob_pve_alltissue <- round(prob_pve_alltissue*100,digits = 2)
  
  

  if (any(mat < 0, na.rm = TRUE)) {
    
    mat_range <- range(mat, na.rm = TRUE)  # includes negatives
    
    # create diverging color function
    col_fun <- colorRamp2(
      c(mat_range[1], 0, mat_range[2]),  # min (neg), 0, max (pos)
      c("blue", "white", "red")          # colors
    )
    
    rownames(mat) <- paste0(rownames(mat)," ",prob_pve_alltissue,"%")
    
    ht2 <- Heatmap(mat,
            name = "%PVE decrease",
            cluster_rows = FALSE,
            cluster_columns = FALSE,
            col = col_fun,
            row_names_side = "left",
            column_title = paste0("%PVE decreased after \n adding the second tissue(column) -- \n", trait," (sQTL)"),
            rect_gp = gpar(col = "black", lwd = 0.5),
            cell_fun = function(j, i, x, y, width, height, fill) {
              if (!is.na(mat[i, j])) {
                grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
              }
            })
    
    
    
  }else{
    
    rownames(mat) <- paste0(rownames(mat)," ",prob_pve_alltissue,"%")
    
       ht2 <- Heatmap(mat,
          name = "%PVE decrease",
          cluster_rows = FALSE,
          cluster_columns = FALSE,
          col = colorRampPalette(c("white", "red"))(100),
          row_names_side = "left",   # can also be "right"
          column_title = paste0("%PVE decreased after  \n adding the second tissue(column) -- \n", trait," (sQTL)"),
          rect_gp = gpar(col = "black", lwd = 0.5),   # draw grid lines
          cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))
          })
    
  }
  

  
  
  draw(ht1 + ht2)
  
}





```
